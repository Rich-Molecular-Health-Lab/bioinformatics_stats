---
title: "Metadata Project Loris"
author: "Alicia Rich"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    css: "microbiome.css"
    toc: true
    toc_location: "before"
    toc_depth: 4
    number_sections: false
    toc_float: true
    code_folding: "hide"
    fig_caption: true
    bibliography: ["/Users/aliciamrich/RStudioMacbook/Bibliographies/loris_mb.bib"]
  link_citations: true
  csl: ["/Users/aliciamrich/RStudioMacbook/Bibliographies/plos.csl"]
params:
  local: "/Users/aliciamrich/RStudioMacbook/GitRepos/microbiomes_loris/"
  laptop: "/Users/aliciamrich/RStudioMacbook/GitRepos/microbiomes_loris/"
  desktop: "/Users/arich/Library/CloudStorage/GoogleDrive-aliciamrich@gmail.com/Other computers/My MacBook Pro/RStudioMacbook/GitRepos/microbiomes_loris/"
  
---

```{r message=FALSE, warning=FALSE, include=FALSE}
source(paste0(params$local, "dependencies/R/setup.R"))
```


# Intro

>This short script is meant to organize our metadata for the Pygmy Loris Sample Collection at Henry Doorly Zoo. You should run the workflow each time you incorporate new results into our dataset to ensure all sequenced microbiome libraries are matched to appropriate contextual metadata.  
  
**Scripts Before This:**  
1. Loris Sample Sheets  
2. Read Processing   
3. *Metadata Loris (This script)*  

**Scripts After This:**  
4. MicroEco Workflow  

## Files Needed:
<ol>
  <li><em>hdz_all_samples_*.csv</em></li>
</ol>

# Create Records {.tabset}

## Diet

```{r diet log culi, message=FALSE, warning=FALSE, paged.print=TRUE}

diet.log.culi   <- tribble(
~category,     ~event_state,  ~title,                   ~ster_mgpml,  ~ster_dose_ml,  ~ster_npday, ~interval                                                , ~subject,
"state_trial", "state"    ,  "baseline"                 ,  0        ,       0   ,      0       ,  interval(make_date(2023, 10, 26), make_date(2023, 11, 01)) , "culi"  ,
"state_trial", "state"    ,  "probiotic"                ,  0        ,       0   ,      0       ,  interval(make_date(2023, 11, 02), make_date(2023, 11, 22)) , "culi"  ,
"state_trial", "state"    ,  "probiotic_oat"            ,  0        ,       0   ,      0       ,  interval(make_date(2023, 11, 23), make_date(2023, 12, 13)) , "culi"  ,
"state_trial", "state"    ,  "steroid"                  ,  10       ,    0.01   ,      1       ,  interval(make_date(2023, 12, 14), make_date(2024, 01, 03)) , "culi"  ,
"state_trial", "state"    ,  "steroid"                  ,  10       ,    0.02   ,      1       ,  interval(make_date(2024, 01, 04), make_date(2024, 01, 24)) , "culi"  ,
"state_trial", "state"    ,  "steroid_probiotic_oat"    ,  10       ,    0.02   ,      1       ,  interval(make_date(2024, 01, 25), make_date(2024, 02, 19)) , "culi"  ,
"state_trial", "state"    ,  "steroid_oat"              ,  10       ,    0.02   ,      1       ,  interval(make_date(2024, 02, 20), make_date(2024, 02, 22)) , "culi"  ,
"state_trial", "state"    ,  "steroid_probiotic_oat"    ,  10       ,    0.02   ,      1       ,  interval(make_date(2024, 02, 23), make_date(2024, 05, 14)) , "culi"  ,
"state_trial", "state"    ,  "steroid_probiotic_oat"    ,  10       ,    0.01   ,      1       ,  interval(make_date(2024, 05, 15), make_date(2024, 05, 22)) , "culi"  ,
"state_trial", "state"    ,  "steroid_probiotic_oat"    ,  10       ,    0.01   ,    0.5       ,  interval(make_date(2024, 05, 23),                 today()) , "culi"  ,
"event_food" , "event"    ,   "tomato removed"          ,  10       ,    0.02   ,      1       ,  interval(make_date(2024, 02, 20), make_date(2024, 02, 20)) , "culi"  ,
"event_food" , "event"    ,   "cauliflower/broc removed",  10       ,    0.02   ,      1       ,  interval(make_date(2024, 01, 22), make_date(2024, 01, 22)) , "culi"  ) %>% 
  
  mutate(ster_mgpday = ster_mgpml * ster_dose_ml * ster_npday,
         start = int_start(interval),
         end   = int_end(interval)) %>% arrange(start, end) 


diet.log.warble   <- tribble(
~category,     ~event_state,  ~title,     ~ster_mgpml,  ~ster_dose_ml,  ~ster_npday, ~interval,                                      ~subject,
"state_trial", "state"    ,  "baseline"   ,  0        ,       0   ,      0         ,  interval(make_date(2023, 10, 26),  today()),    "warble") %>%
  mutate(ster_mgpday = 0,
         start = int_start(interval),
         end   =   int_end(interval)) %>% arrange(start, end) 

diet.log.both <- bind_rows(diet.log.culi, diet.log.warble)

diet.dt       <- diet.log.both %>% filter(category == "state_trial") %>%
                               dplyr::select(-c("interval", 
                                         "category",
                                         "event_state")) %>%
                               mutate(start      = decimal_date(start),
                                      end        = decimal_date(end),
                                      diet_trial = title, 
                                      subject    = factor(subject,
                                                          levels = c("warble",
                                                                     "culi",
                                                                     "unknown",
                                                                     "ntc")),
                                      .keep = "unused") %>% 
                              as.data.table()
setkey(diet.dt, subject, start, end)

diet.culi.dt       <- diet.log.culi %>% filter(category == "state_trial") %>%
                               dplyr::select(start,
                                      end,
                                      culi_trial = title) %>%
                               mutate(start      = decimal_date(start),
                                      end        = decimal_date(end),
                                      .keep = "unused") %>% 
                              as.data.table()
setkey(diet.culi.dt, start, end)
```

```{r}
diet.table <- diet.log.both %>%
  arrange(start, rev(subject)) %>%
  dplyr::select(Subject  = subject,
         Start    = start,
         Diet     = title,
         Ster_mg  = ster_mgpday) %>%
  mutate(Subject  = str_to_title(Subject),
         Diet     = str_to_title(str_replace_all(Diet, "_", " + "))) %>%
  mutate(Diet =   if_else(str_detect(Diet, "Steroid"), 
                  str_glue("{Diet}", fixed(" ("), "{Ster_mg}", fixed(" mg/day)")), Diet)) %>%
  dplyr::select(-Ster_mg) %>%
  kable() %>%
  kable_styling(full_width = T,
                fixed_thead = T,
                c("hover", "responsive"),
                position = "center") %>%
  column_spec(1, bold = T) %>%
  collapse_rows(columns = 1, valign = "top") %>%
  scroll_box(width = "800px", height = "400px")
diet.table
```


## Environment

```{r environment log, message=FALSE, warning=FALSE, paged.print=TRUE}

environment.log <- tribble(
~category,     ~subject,      ~event_state     ,  ~location,                        ~interval,  
"housing"    ,     "culi"  ,  "state"          ,  "old_enclosure"               ,   interval(make_date(2023, 10, 01),       make_date(2024, 02, 27))    , 
"housing"    ,     "warble",  "state"          ,  "old_enclosure"               ,   interval(make_date(2023, 10, 01),       make_date(2024, 02, 28))    ,
"housing"    ,     "culi"  ,  "state"          ,  "new_enclosure"               ,   interval(make_date(2024, 02, 28),                       today())    ,
"housing"    ,     "warble",  "state"          ,  "new_enclosure"               ,   interval(make_date(2024, 02, 29),                       today())    ) %>%
                  mutate(start = int_start(interval),
                         end   =   int_end(interval),
                         subject = factor(subject, levels = c("warble",
                                                              "culi",
                                                              "unknown",
                                                              "ntc")))
housing.dt <- environment.log %>% filter(event_state == "state") %>%
                               dplyr::select(-c("interval", 
                                         "category",
                                         "event_state")) %>%
                                  mutate(start = decimal_date(start),
                                         end   = decimal_date(end)) %>% as.data.table()
setkey(housing.dt, subject, start, end)
```

```{r}
housing.table <- environment.log %>%
  arrange(subject, start) %>%
  dplyr::select(Subject   = subject,
         Start     = start,
         Enclosure = location) %>%
  mutate(Subject  = str_to_title(Subject),
         Enclosure     = str_to_title(str_remove(Enclosure, "_enclosure"))) %>%
  kable() %>%
  kable_styling(full_width = T,
                fixed_thead = T,
                c("hover", "responsive"),
                position = "center") %>%
  column_spec(1, bold = T) %>%
  collapse_rows(columns = 1, valign = "top") %>%
  scroll_box(width = "800px", height = "400px")
housing.table
```


## Health

```{r health records, message=FALSE, warning=FALSE, paged.print=TRUE}

health.log    <- tribble(
~category,      ~event_state,   ~subject,  ~title,                           ~interval,  
"symptom"    ,   "event"      ,   "culi"  ,  "dried blood around anus/tail",   interval(make_date(2023, 11, 16)   ,  make_date(2023, 11, 16))    ,
"behavior"   ,   "event"      ,   "culi"  ,  "coprophagy observed"         ,   interval(make_date(2023, 12, 17)   ,  make_date(2023, 12, 17))    ,
"weight"     ,   "event"      ,   "culi"  ,  "weight - 451 g"              ,   interval(make_date(2024, 04, 14)   ,  make_date(2024, 04, 14))    ,
"behavior"   ,   "event"      ,   "culi"  ,  "coprophagy observed"         ,   interval(make_date(2024, 01, 21)   ,  make_date(2024, 01, 21))    ,
"behavior"   ,   "event"      ,   "culi"  ,  "left biscuit/gum behind"     ,   interval(make_date(2024, 02, 10)   ,  make_date(2024, 02, 10))    ,
"repro"      ,   "event"      ,   "warble",  "gave birth to healthy twins" ,   interval(make_date(2024, 10, 09)   ,  make_date(2024, 10, 09))    ,
"repro"      ,   "event"      ,   "warble",  "killed/ate both twins"       ,   interval(make_date(2024, 10, 10)   ,  make_date(2024, 10, 10))    ) %>%
                  mutate(start = int_start(interval),
                         end   = int_end(interval)) %>% 
                                                        mutate(subject = 
                                                        factor(subject, 
                                                        levels = 
                                                            c("warble",
                                                              "culi",
                                                              "unknown",
                                                              "ntc")))
```

```{r}
health.table <- health.log %>%
  arrange(start, subject) %>%
  dplyr::select(Subject  = subject,
         Date     = start,
         Category = category,
         Note     = title) %>%
  mutate(Subject  = str_to_title(Subject),
         Category = str_to_title(Category),
         Note     = str_to_sentence(Note)) %>%
  kable() %>%
  kable_styling(full_width = T,
                fixed_thead = T,
                c("hover", "responsive"),
                position = "center") %>%
  column_spec(1, bold = T) %>%
  collapse_rows(columns = 1, valign = "top") %>%
  scroll_box(width = "800px", height = "400px")
health.table
```


## Meds

```{r medication records, message=FALSE, warning=FALSE, paged.print=TRUE}
meds    <- tribble(
~subject,     ~med_type,      ~med_name,        ~mgpml,     ~dose_ml,   ~dose_npday,           ~interval,  
"culi"     ,  "steroid"     , "Budesonide"    ,  10       ,   0.01     ,   1         ,    interval(make_date(2023, 12, 14),   make_date(2024, 01, 03)) ,
"culi"     ,  "steroid"     , "Budesonide"    ,  10       ,   0.02     ,   1         ,    interval(make_date(2024, 01, 04),   make_date(2024, 05, 14)) ,
"culi"     ,  "steroid"     , "Budesonide"    ,  10       ,   0.01     ,   1         ,    interval(make_date(2024, 05, 15),   make_date(2024, 05, 22)) ,
"culi"     ,  "steroid"     , "Budesonide"    ,  10       ,   0.01     ,   0.5       ,    interval(make_date(2024, 05, 22),                   today()) ,
"culi"     ,  "antibiotic"  , "Metronidazole" ,  250      ,   0.05     ,   1         ,    interval(make_date(2024, 04, 29),   make_date(2024, 05, 06)) ,
"both"     ,  "none"        , "none"          ,  0        ,   0        ,   0         ,    interval(make_date(2023, 10, 26),   make_date(2023, 11, 01)) 
) %>% 
  
  mutate(mg_p_day = mgpml * dose_ml * dose_npday,
         start    = int_start(interval),
         end      = int_end(interval)) %>% arrange(start, end) %>%
                       filter(med_type != "none") %>% 
                                                        mutate(subject = 
                                                        factor(subject, 
                                                        levels = 
                                                            c("warble",
                                                              "culi",
                                                              "unknown",
                                                              "ntc")))
meds.dt  <- meds %>% filter(med_type != "steroid") %>% 
  mutate(start = decimal_date(start),
         end   = decimal_date(end)) %>%
  dplyr::select(-interval) %>%
  as.data.table()
setkey(meds.dt, subject, start, end)
```

## Repro

```{r repro log, message=FALSE, warning=FALSE, paged.print=TRUE}

repro.log    <- tribble(
  
~category,     ~event_state,    ~title,                  ~interval,  
"access"      ,     "state"  ,  "together"              ,   interval(make_date(2023, 10, 01),       make_date(2023, 10, 29))    ,
"w_cycle"     ,     "state"  ,  "estrus"                ,   interval(make_date(2023, 10, 01),       make_date(2023, 10, 29))    ,
"access"      ,     "state"  ,  "separated"             ,   interval(make_date(2023, 10, 30),       make_date(2024, 04, 01))    ,
"w_cycle"     ,     "state"  ,  "estrus"                ,   interval(make_date(2024, 04, 01),       make_date(2024, 04, 05))    ,    
"access"      ,     "state"  ,  "together"              ,   interval(make_date(2024, 04, 02),       make_date(2024, 04, 15))    ,
"physiology"  ,     "event"  ,  "swollen_testicles"     ,   interval(make_date(2024, 02, 29),       make_date(2024, 02, 29))    ,
"physiology"  ,     "event"  ,  "swollen_vulva"         ,   interval(make_date(2024, 03, 21),       make_date(2024, 03, 21))    ,
"behavior"    ,     "event"  ,  "culi_whistling"        ,   interval(make_date(2024, 03, 21),       make_date(2024, 03, 21))    ,
"behavior"    ,     "event"  ,  "warble_whistling"      ,   interval(make_date(2024, 04, 04),       make_date(2024, 04, 04))    ,
"copulation"  ,     "event"  ,  "copulation_observed"   ,   interval(make_date(2024, 04, 03),       make_date(2024, 04, 03))    ,
"copulation"  ,     "event"  ,  "copulation_observed"   ,   interval(make_date(2024, 04, 04),       make_date(2024, 04, 04))    ,
"copulation"  ,     "event"  ,  "sperm_plug_observed"   ,   interval(make_date(2024, 04, 05),       make_date(2024, 04, 05))    ,
"w_cycle"     ,     "state"  ,  "not_pregnant"          ,   interval(make_date(2023, 10, 01),       make_date(2024, 04, 05))    ,
"w_cycle"     ,     "state"  ,  "pregnant"              ,   interval(make_date(2024, 04, 05),       make_date(2024, 10, 09))    ,
"w_cycle"     ,     "event"  ,  "birth"                 ,   interval(make_date(2024, 10, 09),       make_date(2024, 10, 09))    ,
"w_cycle"     ,     "state"  ,  "not_pregnant"          ,   interval(make_date(2024, 10, 09),       now())                      ,
"w_cycle"     ,     "event"  ,  "infanticide"           ,   interval(make_date(2024, 10, 10),       make_date(2024, 10, 10))    ) %>%
                  mutate(start = int_start(interval),
                         end = int_end(interval))

warble.cyle.dt        <- repro.log %>% filter(category == "w_cycle")  %>% 
  mutate(warble_cycle = title,
         start        = decimal_date(start),
         end          = decimal_date(end)) %>%  
                               dplyr::select(-c(
                                         "interval", 
                                         "category",
                                         "event_state",
                                         "title")) %>%
  as.data.table()

setkey(warble.cyle.dt, start, end)

breeding.access.dt    <- repro.log %>% filter(category == "access")   %>% 
  mutate(access       = title,
         start        = decimal_date(start),
         end          = decimal_date(end), .keep = "unused") %>% 
                               dplyr::select(-c(
                                         "interval", 
                                         "category",
                                         "event_state")) %>%
  as.data.table()

setkey(breeding.access.dt, start, end)

```

## Bristol Fecal Scores

```{r bristol fecal scores, message=FALSE, warning=FALSE, paged.print=TRUE}

bristol <- tribble(
                    ~score_culi,   ~date,
                  as.integer(3)        ,   (make_date(2023, 10, 26))   ,
                  as.integer(5)        ,   (make_date(2023, 10, 26))   ,
                  as.integer(3)        ,   (make_date(2023, 10, 27))   ,
                  as.integer(6)        ,   (make_date(2023, 10, 27))   ,
                  as.integer(3)        ,   (make_date(2023, 10, 28))   , 
                  as.integer(3)        ,   (make_date(2023, 10, 29))   ,
                  as.integer(3)        ,   (make_date(2023, 10, 30))   ,
                  as.integer(3)        ,   (make_date(2023, 10, 31))   ,
                  as.integer(3)        ,   (make_date(2023, 11, 01))   ,
                  as.integer(3)        ,   (make_date(2023, 11, 02))   ,
                  as.integer(6)        ,   (make_date(2023, 11, 02))   ,
                  as.integer(3)        ,   (make_date(2023, 11, 03))   ,
                  as.integer(3)        ,   (make_date(2023, 11, 04))   ,
                  as.integer(3)        ,   (make_date(2023, 11, 05))   ,
                  as.integer(3)        ,   (make_date(2023, 11, 06))   ,
                  as.integer(5)        ,   (make_date(2023, 11, 06))   ,
                  as.integer(3)        ,   (make_date(2023, 11, 07))   ,
                  as.integer(3)        ,   (make_date(2023, 11, 08))   ,
                  as.integer(3)        ,   (make_date(2023, 11, 09))   ,
                  as.integer(3)        ,   (make_date(2023, 11, 10))   ,
                  as.integer(3)        ,   (make_date(2023, 11, 11))   ,
                  as.integer(3)        ,   (make_date(2023, 11, 12))   ,
                  as.integer(3)        ,   (make_date(2023, 11, 13))   ,
                  as.integer(3)        ,   (make_date(2023, 11, 14))   ,
                  as.integer(3)        ,   (make_date(2023, 11, 15))   ,
                  as.integer(3)        ,   (make_date(2023, 11, 16))   ,
                  as.integer(3)        ,   (make_date(2023, 11, 17))   ,
                  as.integer(3)        ,   (make_date(2023, 11, 18))   ,
                  as.integer(3)        ,   (make_date(2023, 11, 19))   ,
                  as.integer(3)        ,   (make_date(2023, 11, 20))   ,
                  as.integer(3)        ,   (make_date(2023, 11, 21))   ,
                  as.integer(6)        ,   (make_date(2023, 11, 22))   ,
                  as.integer(3)        ,   (make_date(2023, 11, 23))   ,
                  as.integer(3)        ,   (make_date(2023, 11, 24))   ,
                  as.integer(6)        ,   (make_date(2023, 11, 25))   ,
                  as.integer(3)        ,   (make_date(2023, 11, 26))   ,
                  as.integer(3)        ,   (make_date(2023, 11, 27))   ,
                  as.integer(3)        ,   (make_date(2023, 11, 28))   ,
                  as.integer(3)        ,   (make_date(2023, 11, 29))   ,
                  as.integer(3)        ,   (make_date(2023, 11, 30))   ,
                  as.integer(3)        ,   (make_date(2023, 12, 01))   ,
                  as.integer(3)        ,   (make_date(2023, 12, 02))   ,
                  as.integer(3)        ,   (make_date(2023, 12, 03))   ,
                  as.integer(6)        ,   (make_date(2023, 12, 03))   ,
                  as.integer(3)        ,   (make_date(2023, 12, 04))   ,
                  as.integer(2)        ,   (make_date(2023, 12, 05))   ,
                  as.integer(3)        ,   (make_date(2023, 12, 05))   ,
                  as.integer(3)        ,   (make_date(2023, 12, 06))   ,
                  as.integer(3)        ,   (make_date(2023, 12, 07))   ,
                  as.integer(3)        ,   (make_date(2023, 12, 09))   ,
                  as.integer(3)        ,   (make_date(2023, 12, 10))   ,
                  as.integer(3)        ,   (make_date(2023, 12, 11))   ,
                  as.integer(3)        ,   (make_date(2023, 12, 12))   ,
                  as.integer(3)        ,   (make_date(2023, 12, 13))   ,
                  as.integer(3)        ,   (make_date(2023, 12, 14))   ,
                  as.integer(5)        ,   (make_date(2023, 12, 15))   ,
                  as.integer(6)        ,   (make_date(2023, 12, 15))   ,
                  as.integer(3)        ,   (make_date(2023, 12, 16))   ,
                  as.integer(3)        ,   (make_date(2023, 12, 17))   ,
                  as.integer(3)        ,   (make_date(2023, 12, 17))   ,
                  as.integer(3)        ,   (make_date(2023, 12, 18))   ,
                  as.integer(3)        ,   (make_date(2023, 12, 19))   ,
                  as.integer(2)        ,   (make_date(2023, 12, 20))   ,
                  as.integer(3)        ,   (make_date(2023, 12, 21))   ,
                  as.integer(3)        ,   (make_date(2023, 12, 22))   ,
                  as.integer(3)        ,   (make_date(2023, 12, 23))   ,
                  as.integer(3)        ,   (make_date(2023, 12, 24))   ,
                  as.integer(3)        ,   (make_date(2023, 12, 25))   ,
                  as.integer(3)        ,   (make_date(2023, 12, 26))   ,
                  as.integer(3)        ,   (make_date(2023, 12, 27))   ,
                  as.integer(5)        ,   (make_date(2023, 12, 27))   ,
                  as.integer(3)        ,   (make_date(2023, 12, 28))   ,
                  as.integer(3)        ,   (make_date(2023, 12, 29))   ,
                  as.integer(3)        ,   (make_date(2023, 12, 30))   ,
                  as.integer(6)        ,   (make_date(2023, 12, 30))   ,
                  as.integer(3)        ,   (make_date(2023, 12, 31))   ,
                  as.integer(3)        ,   (make_date(2024, 01, 01))   ,
                  as.integer(3)        ,   (make_date(2024, 01, 02))   ,
                  as.integer(3)        ,   (make_date(2024, 01, 03))   ,
                  as.integer(6)        ,   (make_date(2024, 01, 03))   ,
                  as.integer(3)        ,   (make_date(2024, 01, 04))   ,
                  as.integer(3)        ,   (make_date(2024, 01, 05))   ,
                  as.integer(6)        ,   (make_date(2024, 01, 06))   ,
                  as.integer(3)        ,   (make_date(2024, 01, 07))   ,
                  as.integer(3)        ,   (make_date(2024, 01, 08))   ,
                  as.integer(3)        ,   (make_date(2024, 01, 09))   ,
                  as.integer(3)        ,   (make_date(2024, 01, 10))   ,
                  as.integer(3)        ,   (make_date(2024, 01, 11))   ,
                  as.integer(3)        ,   (make_date(2024, 01, 12))   ,
                  as.integer(3)        ,   (make_date(2024, 01, 13))   ,
                  as.integer(3)        ,   (make_date(2024, 01, 14))   ,
                  as.integer(3)        ,   (make_date(2024, 01, 15))   ,
                  as.integer(0)        ,   (make_date(2024, 01, 16))   ,
                  as.integer(3)        ,   (make_date(2024, 01, 17))   ,
                  as.integer(6)        ,   (make_date(2024, 01, 17))   ,
                  as.integer(2)        ,   (make_date(2024, 01, 18))   ,
                  as.integer(1)        ,   (make_date(2024, 01, 19))   ,
                  as.integer(2)        ,   (make_date(2024, 01, 20))   ,
                  as.integer(6)        ,   (make_date(2024, 01, 21))   ,
                  as.integer(6)        ,   (make_date(2024, 01, 22))   ,
                  as.integer(2)        ,   (make_date(2024, 01, 23))   ,
                  as.integer(2)        ,   (make_date(2024, 01, 24))   ,
                  as.integer(5)        ,   (make_date(2024, 01, 25))   ,
                  as.integer(6)        ,   (make_date(2024, 01, 25))   ,
                  as.integer(5)        ,   (make_date(2024, 01, 26))   ,
                  as.integer(6)        ,   (make_date(2024, 01, 27))   ,
                  as.integer(2)        ,   (make_date(2024, 01, 28))   ,
                  as.integer(2)        ,   (make_date(2024, 01, 29))   ,
                  as.integer(2)        ,   (make_date(2024, 01, 30))   ,
                  as.integer(2)        ,   (make_date(2024, 01, 31))   ,
                  as.integer(3)        ,   (make_date(2024, 02, 01))   ,
                  as.integer(2)        ,   (make_date(2024, 02, 02))   ,
                  as.integer(2)        ,   (make_date(2024, 02, 03))   ,
                  as.integer(2)        ,   (make_date(2024, 02, 04))   ,
                  as.integer(2)        ,   (make_date(2024, 02, 05))   ,
                  as.integer(2)        ,   (make_date(2024, 02, 06))   ,
                  as.integer(3)        ,   (make_date(2024, 02, 07))   ,
                  as.integer(3)        ,   (make_date(2024, 02, 08))   ,
                  as.integer(6)        ,   (make_date(2024, 02, 08))   ,
                  as.integer(2)        ,   (make_date(2024, 02, 09))   ,
                  as.integer(6)        ,   (make_date(2024, 02, 10))   ,
                  as.integer(2)        ,   (make_date(2024, 02, 11))   ,
                  as.integer(2)        ,   (make_date(2024, 02, 12))   ,
                  as.integer(2)        ,   (make_date(2024, 02, 13))   ,
                  as.integer(3)        ,   (make_date(2024, 02, 14))   ,
                  as.integer(6)        ,   (make_date(2024, 02, 14))   ,
                  as.integer(2)        ,   (make_date(2024, 02, 15))   ,
                  as.integer(3)        ,   (make_date(2024, 02, 16))   ,
                  as.integer(2)        ,   (make_date(2024, 02, 17))   ,
                  as.integer(2)        ,   (make_date(2024, 02, 18))   ,
                  as.integer(2)        ,   (make_date(2024, 02, 19))   ,
                  as.integer(2)        ,   (make_date(2024, 02, 20))   ,
                  as.integer(3)        ,   (make_date(2024, 02, 21))   ,
                  as.integer(3)        ,   (make_date(2024, 02, 22))   ,
                  as.integer(2)        ,   (make_date(2024, 02, 23))   ,
                  as.integer(2)        ,   (make_date(2024, 02, 24))   ,
                  as.integer(2)        ,   (make_date(2024, 02, 25))   ,
                  as.integer(2)        ,   (make_date(2024, 02, 26))   ,
                  as.integer(2)        ,   (make_date(2024, 02, 27))   ,
                  as.integer(2)        ,   (make_date(2024, 02, 28))   ,
                  as.integer(2)        ,   (make_date(2024, 02, 29))   ,
                  as.integer(2)        ,   (make_date(2024, 03, 01))   ,
                  as.integer(2)        ,   (make_date(2024, 03, 02))   ,
                  as.integer(2)        ,   (make_date(2024, 03, 03))   ,
                  as.integer(6)        ,   (make_date(2024, 03, 03))   ,
                  as.integer(6)        ,   (make_date(2024, 03, 04))   ,
                  as.integer(2)        ,   (make_date(2024, 03, 05))   ,
                  as.integer(3)        ,   (make_date(2024, 03, 05))   ,
                  as.integer(2)        ,   (make_date(2024, 03, 06))   ,
                  as.integer(3)        ,   (make_date(2024, 03, 06))   ,
                  as.integer(5)        ,   (make_date(2024, 03, 06))   ,
                  as.integer(3)        ,   (make_date(2024, 03, 07))   ,
                  as.integer(3)        ,   (make_date(2024, 03, 08))   ,
                  as.integer(6)        ,   (make_date(2024, 03, 08))   ,
                  as.integer(3)        ,   (make_date(2024, 03, 09))   ,
                  as.integer(6)        ,   (make_date(2024, 03, 09))   ,
                  as.integer(3)        ,   (make_date(2024, 03, 10))   ,
                  as.integer(6)        ,   (make_date(2024, 03, 10))   ,
                  as.integer(3)        ,   (make_date(2024, 03, 11))   ,
                  as.integer(5)        ,   (make_date(2024, 03, 11))   ,
                  as.integer(3)        ,   (make_date(2024, 03, 12))   ,
                  as.integer(4)        ,   (make_date(2024, 03, 13))   ,
                  as.integer(6)        ,   (make_date(2024, 03, 13))   ,
                  as.integer(3)        ,   (make_date(2024, 03, 14))   ,
                  as.integer(3)        ,   (make_date(2024, 03, 15))   ,
                  as.integer(6)        ,   (make_date(2024, 03, 15))   ,
                  as.integer(5)        ,   (make_date(2024, 03, 16))   ,
                  as.integer(6)        ,   (make_date(2024, 03, 16))   ,
                  as.integer(3)        ,   (make_date(2024, 03, 17))   ,
                  as.integer(3)        ,   (make_date(2024, 03, 18))   ,
                  as.integer(5)        ,   (make_date(2024, 03, 18))   ,
                  as.integer(5)        ,   (make_date(2024, 03, 19))   ,
                  as.integer(5)        ,   (make_date(2024, 03, 20))   ,
                  as.integer(3)        ,   (make_date(2024, 03, 21))   ,
                  as.integer(5)        ,   (make_date(2024, 03, 21))   ,
                  as.integer(5)        ,   (make_date(2024, 03, 22))   ,
                  as.integer(6)        ,   (make_date(2024, 03, 22))   ,
                  as.integer(5)        ,   (make_date(2024, 03, 23))   ,
                  as.integer(6)        ,   (make_date(2024, 03, 23))   ,
                  as.integer(3)        ,   (make_date(2024, 03, 24))   ,
                  as.integer(6)        ,   (make_date(2024, 03, 24))   ,
                  as.integer(5)        ,   (make_date(2024, 03, 25))   ,
                  as.integer(3)        ,   (make_date(2024, 03, 26))   ,
                  as.integer(3)        ,   (make_date(2024, 03, 27))   ,
                  as.integer(6)        ,   (make_date(2024, 03, 27))   ,
                  as.integer(2)        ,   (make_date(2024, 03, 28))   ,
                  as.integer(3)        ,   (make_date(2024, 03, 28))   ,
                  as.integer(3)        ,   (make_date(2024, 03, 29))   ,
                  as.integer(3)        ,   (make_date(2024, 03, 30))   ,
                  as.integer(4)        ,   (make_date(2024, 03, 31))   ,
                  as.integer(6)        ,   (make_date(2024, 03, 31))   ,
                  as.integer(3)        ,   (make_date(2024, 04, 01))   ,
                  as.integer(6)        ,   (make_date(2024, 04, 01))   ,
                  as.integer(3)        ,   (make_date(2024, 04, 02))   ,
                  as.integer(3)        ,   (make_date(2024, 04, 03))   ,
                  as.integer(6)        ,   (make_date(2024, 04, 03))   ,
                  as.integer(3)        ,   (make_date(2024, 04, 04))   ,
                  as.integer(6)        ,   (make_date(2024, 04, 04))   ,
                  as.integer(3)        ,   (make_date(2024, 04, 05))   ,
                  as.integer(4)        ,   (make_date(2024, 04, 05))   ,
                  as.integer(3)        ,   (make_date(2024, 04, 06))   ,
                  as.integer(4)        ,   (make_date(2024, 04, 06))   ,
                  as.integer(3)        ,   (make_date(2024, 04, 07))   ,
                  as.integer(6)        ,   (make_date(2024, 04, 07))   ,
                  as.integer(3)        ,   (make_date(2024, 04, 08))   ,
                  as.integer(6)        ,   (make_date(2024, 04, 08))   ,
                  as.integer(3)        ,   (make_date(2024, 04, 09))   ,
                  as.integer(6)        ,   (make_date(2024, 04, 09))   ,
                  as.integer(3)        ,   (make_date(2024, 04, 10))   ,
                  as.integer(6)        ,   (make_date(2024, 04, 10))   ,
                  as.integer(3)        ,   (make_date(2024, 04, 11))   ,
                  as.integer(6)        ,   (make_date(2024, 04, 11))   ,
                  as.integer(3)        ,   (make_date(2024, 04, 12))   ,
                  as.integer(4)        ,   (make_date(2024, 04, 12))   ,
                  as.integer(3)        ,   (make_date(2024, 04, 13))   ,
                  as.integer(4)        ,   (make_date(2024, 04, 13))   ,
                  as.integer(3)        ,   (make_date(2024, 04, 14))   ,
                  as.integer(6)        ,   (make_date(2024, 04, 14))   ,
                  as.integer(3)        ,   (make_date(2024, 04, 16))   ,
                  as.integer(4)        ,   (make_date(2024, 04, 16))   ,
                  as.integer(3)        ,   (make_date(2024, 04, 17))   ,
                  as.integer(6)        ,   (make_date(2024, 04, 17))   ,
                  as.integer(6)        ,   (make_date(2024, 04, 18))   ,
                  as.integer(3)        ,   (make_date(2024, 04, 19))   ,
                  as.integer(6)        ,   (make_date(2024, 04, 19))   ,
                  as.integer(3)        ,   (make_date(2024, 04, 20))   ,
                  as.integer(6)        ,   (make_date(2024, 04, 20))   ,
                  as.integer(6)        ,   (make_date(2024, 04, 21))   ,
                  as.integer(6)        ,   (make_date(2024, 04, 22))   ,
                  as.integer(3)        ,   (make_date(2024, 04, 22))   ,
                  as.integer(3)        ,   (make_date(2024, 04, 25))   ,
                  as.integer(6)        ,   (make_date(2024, 04, 25))   ,
                  as.integer(3)        ,   (make_date(2024, 04, 26))   ,
                  as.integer(6)        ,   (make_date(2024, 04, 26))   ,
                  as.integer(3)        ,   (make_date(2024, 04, 27))   ,
                  as.integer(4)        ,   (make_date(2024, 04, 27))   ,
                  as.integer(6)        ,   (make_date(2024, 04, 28))   ,
                  as.integer(6)        ,   (make_date(2024, 04, 29))   ,
                  as.integer(4)        ,   (make_date(2024, 04, 29))   ,
                  as.integer(5)        ,   (make_date(2024, 04, 30))   ,
                  as.integer(3)        ,   (make_date(2024, 04, 30))   ,
                  as.integer(6)        ,   (make_date(2024, 05, 02))   ,
                  as.integer(5)        ,   (make_date(2024, 05, 03))   ,
                  as.integer(6)        ,   (make_date(2024, 05, 03))   ,
                  as.integer(4)        ,   (make_date(2024, 05, 04))   ,
                  as.integer(6)        ,   (make_date(2024, 05, 04))   ,
                  as.integer(6)        ,   (make_date(2024, 05, 05))   ,
                  as.integer(6)        ,   (make_date(2024, 05, 06))   ,
                  as.integer(3)        ,   (make_date(2024, 05, 08))   ,
                  as.integer(6)        ,   (make_date(2024, 05, 08))   ,
                  as.integer(3)        ,   (make_date(2024, 05, 09))   ,
                  as.integer(6)        ,   (make_date(2024, 05, 09))   ,
                  as.integer(4)        ,   (make_date(2024, 05, 10))   ,
                  as.integer(6)        ,   (make_date(2024, 05, 11))   ,
                  as.integer(6)        ,   (make_date(2024, 05, 12))   ,
                  as.integer(3)        ,   (make_date(2024, 05, 13))   ,
                  as.integer(5)        ,   (make_date(2024, 05, 13))   ,
                  as.integer(5)        ,   (make_date(2024, 05, 14))   ,
                  as.integer(3)        ,   (make_date(2024, 05, 14))   ,
                  as.integer(6)        ,   (make_date(2024, 05, 16))   ,
                  as.integer(3)        ,   (make_date(2024, 05, 17))   ,
                  as.integer(6)        ,   (make_date(2024, 05, 17))   ,
                  as.integer(3)        ,   (make_date(2024, 05, 19))   ,
                  as.integer(6)        ,   (make_date(2024, 05, 19))   ,
                  as.integer(3)        ,   (make_date(2024, 05, 20))   ,
                  as.integer(4)        ,   (make_date(2024, 05, 20))   ,
                  as.integer(6)        ,   (make_date(2024, 05, 20))   ,
                  as.integer(3)        ,   (make_date(2024, 05, 21))   ,
                  as.integer(6)        ,   (make_date(2024, 05, 21))   ,
                  as.integer(3)        ,   (make_date(2024, 05, 22))   ,
                  as.integer(3)        ,   (make_date(2024, 05, 23))   ,
                  as.integer(6)        ,   (make_date(2024, 05, 23))   ,
                  as.integer(3)        ,   (make_date(2024, 05, 24))   ,
                  as.integer(4)        ,   (make_date(2024, 05, 24))   ,
                  as.integer(3)        ,   (make_date(2024, 05, 25))   ,
                  as.integer(4)        ,   (make_date(2024, 05, 25))   ,
                  as.integer(3)        ,   (make_date(2024, 05, 26))   ,
                  as.integer(6)        ,   (make_date(2024, 05, 26))   )
```

# Match Metadata to Samples {.tabset}

```{r}
samples    <- read.recent.version.tsv("dataframes", "hdz_all_samples_") %>%
                       mutate(collection = as_date(collection)) %>%
                       filter(subject == "warble" |
                              subject == "culi")

samples.dt <- samples   %>% filter(!is.na(collection)) %>% 
                                           mutate(collection        = decimal_date(as.POSIXct(collection)),
                                                  collection_y      = collection,
                                                  subject = factor(subject, levels = c("warble", "culi"))) %>%
                                    select(alias, subject, collection, collection_y) %>%
                      as.data.table()

setkey(samples.dt, subject, collection, collection_y)

samples.nosubj.dt <- as.data.table(samples.dt)
setkey(samples.nosubj.dt,   collection, collection_y)
```


## Merge Set 1

### Diet

```{r metadata diet, message=FALSE, warning=FALSE, paged.print=TRUE}
samples.diet  <- foverlaps(samples.dt, diet.dt, type = "any", nomatch = NA, mult = "all") %>% tibble() %>%
  select(-c("collection", 
            "collection_y",
            "start",
            "end"))
```

### Housing

```{r metadata housing, message=FALSE, warning=FALSE, paged.print=TRUE}
samples.housing      <- foverlaps(samples.dt, housing.dt, type = "any", nomatch = 0L) %>% tibble() %>%
  select(-c("collection", 
            "collection_y",
            "start",
            "end"))
```

### Medication

```{r metadata meds, message=FALSE, warning=FALSE, paged.print=TRUE}
samples.meds <- foverlaps(samples.dt, meds.dt, type = "any", nomatch = 0L) %>% tibble() %>%
  select(-c("collection", 
            "collection_y",
            "start",
            "end"))
```

## Merge Set 2

### Culi's Diet Phases Only
```{r}
samples.culi.diet <- foverlaps(samples.nosubj.dt, diet.culi.dt, type = "any", nomatch = NA, mult = "all") %>%
  tibble() %>%
  select(-c("collection", 
            "collection_y",
            "start",
            "end"))
```


### Estrus Cycles

```{r metadata estrus, message=FALSE, warning=FALSE, paged.print=TRUE}
samples.estrus    <- foverlaps(samples.nosubj.dt, warble.cyle.dt, type = "any", nomatch = 0L) %>%
  tibble() %>%
  select(-c("collection", 
            "collection_y",
            "start",
            "end"))
```

### Breeding Access

```{r metadata breeding access, message=FALSE, warning=FALSE, paged.print=TRUE}
samples.access <- foverlaps(samples.nosubj.dt, breeding.access.dt, type = "any", nomatch = 0L) %>%
  tibble() %>%
  select(-c("collection", 
            "collection_y",
            "start",
            "end"))
```

## Merge Set 3

### Notes Diet Changes

```{r message=FALSE, warning=FALSE, paged.print=FALSE}
notes.diet  <- diet.log.both %>% filter(event_state == "event") %>% 
                                  group_by(start, subject) %>% 
                                  summarize(diet_change = str_flatten(title, ", ", na.rm = TRUE)) %>% 
                                  ungroup() %>%
                                  mutate(note_type   = "diet_change",
                                         note_detail = diet_change, .keep = "unused")
```

### Notes Health

```{r message=FALSE, warning=FALSE}
notes.health  <- health.log %>% filter(event_state == "event") %>% 
                              group_by(start, subject) %>% 
                             summarize(category = str_flatten(category, ", ", na.rm = TRUE),
                                    title       = str_flatten(title,    ", ", na.rm = TRUE)) %>% 
                              ungroup() %>%
                            mutate(note_type   = str_glue("health_", "{category}"),
                                   note_detail = title, .keep = "unused")

```

### Notes Repro

```{r message=FALSE, warning=FALSE}
notes.repro  <- repro.log %>% filter(event_state == "event") %>% 
                            group_by(start) %>% 
                          summarize(category   = str_flatten(category,   ", ", na.rm = TRUE),
                                    title      = str_flatten(title, ", ", na.rm = TRUE)) %>% ungroup()

notes.repro.c <- notes.repro %>% mutate(subject = factor("culi"))
notes.repro.w <- notes.repro %>% mutate(subject = factor("warble"))

notes.repro <- bind_rows(notes.repro.c, notes.repro.w) %>%
                        mutate(note_type   = str_glue("repro_", "{category}"),
                               note_detail = title,
                               .keep = "unused")
```

## Bristol Scores

```{r}
bristol.range    <- bristol %>% mutate(subject = factor("culi"),
                                      bristol = score_culi, 
                                      .keep = "unused") %>% 
                              group_by(date, subject) %>%
                                      summarize(bristol_min  = min(bristol),
                                                bristol_max  = max(bristol),
                                                bristol_mean = round(mean(bristol), digits = 1)) %>% ungroup()
```

# Combining Match Sets {.tabset}

## Set 1 Together

```{r warning=FALSE}
samples.set1 <- samples %>% left_join(samples.diet,    by = join_by(alias, subject)) %>%
                            left_join(samples.housing, by = join_by(alias, subject)) %>%
                            left_join(samples.meds,    by = join_by(alias, subject)) %>%
                            mutate(across(where(is.numeric), replace_na, 0))
```

## Set 2 Together

```{r warning=FALSE}
samples.set1.2 <- samples.set1 %>% left_join(samples.estrus,    by = join_by(alias, subject)) %>%
                                   left_join(samples.access,    by = join_by(alias, subject)) %>%
                                   left_join(samples.culi.diet, by = join_by(alias, subject)) %>%
                                   mutate(across(where(is.numeric), replace_na, 0)) %>%
                                   mutate(warble_cycle = replace_na(warble_cycle, "not_estrus"),
                                          med_type     = replace_na(med_type, "none"),
                                          med_name     = replace_na(med_name, "none"))
```

## Set 3 Together

```{r message=FALSE, warning=FALSE}
set3.notes <- bind_rows(notes.diet,
                        notes.health,
                        notes.repro) %>%
              ungroup() %>%
              group_by(start, subject) %>%
              summarize(note_type   = str_flatten(note_type,   "; ", na.rm = TRUE),
                        note_detail = str_flatten(note_detail, "; ", na.rm = TRUE)) %>%
              ungroup()
```

## All Together

```{r}
samples.metadata <- samples.set1.2 %>% left_join(bristol.range,
                                                 by = join_by(collection == date, subject)) %>%
                                       left_join(set3.notes,
                                                 by = join_by(collection == start, subject)) %>%
                                       mutate(note_type   = replace_na("none"),
                                              note_detail = replace_na("none"))  %>%
  arrange(collection, subject, sampleID)

backup.df(samples.metadata, "samples_metadata")
```


```{r}
samples.metadata %>%
  kbl() %>%
  kable_styling(full_width = T,
                fixed_thead = T,
                c("hover", "responsive"),
                position = "center") %>%
  column_spec(1, bold = T) %>%
  collapse_rows(columns = 1, valign = "top") %>%
  scroll_box(width = "800px", height = "400px")

```

# Next Steps

>Now you should proceed to the MicroEco Workflow to Begin Merging Metadata with Microbiome Results for Analysis.
