---
title: "Demographic Data Summaries for AZA Pygmy Loris Provisional SSP"
author: "Alicia Rich"
output:
  html_document:
    theme:
      bootswatch: litera
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: true
    code_folding: "show"
    fig_caption: true
    df_print: paged
params:
  sampleset: "loris"
  dataset: "culi"
                     
---

```{r global, message = FALSE}
global             <- config::get(config = "default")

here::i_am("DemographicsLorises.Rmd")
source(here::here(global$setup))
```

```{r}
comments <- list(
  "ANALYTICAL DATA FOR TRUE INDIVIDUALS" = list(
    "2108" = list(
    "Field"   = "Sire",
    "TRUE"    = "UNK",
    "Overlay" = "HYP1",
    "Note"    = 
    "No individuals in the SB are recorded as having been at institution at which 2108 was born (IRCHEL) other than SB#s 2108 and 2097. Therefore, created and assigned a wild-origin hypothetical sire, which seems reasonable given the birth date of SB# 2108 and the origins of the recorded mother."),
  "2717" = list(
    "Field"   = c("Sire", "Dam"),
    "TRUE"    = "UNK",
    "Overlay" = c("HYP2", "HYP3"),
    "Note"    = 
    "This individual is possibly from the pet trade. No other animals from GREENWICH or VA SAFARI have previously entered the studbook, so the animal is unlikely to be related to any individuals currently in the population. Assumed to have wild (unrelated) origins.")
  ),
  "HYPOTHETICAL INDIVIDUALS" = list(
    "HYP1" = list(
      "Sire" = "WILD",
      "Dam"  = "WILD",
      "Note" = "To represent likely wild caught sire of SB# 2108, which was born at IRCHEL in Switzerland on 4/10/1989."
    ),
    "HYP2" = list(
      "Sire" = "WILD",
      "Dam"  = "WILD",
      "Note" = "Created to represent parents of 2717, which is likely unrelated to the rest of the population due to origin."),
    "HYP3" = list(
      "Sire" = "WILD",
      "Dam"  = "WILD",
      "Note" = "Created to represent parents of 2717, which is likely unrelated to the rest of the population due to origin.")
  )
)
```

```{r}
locationsCurrent25 <- read.csv(here(path$AZAstudbooks$institutions$current25)) %>%
  select(Name    = Institution.Name, Label   = Mnemonic) %>%
  mutate(Country = "United States")

locationsCurrent21 <- read.csv(here(path$AZAstudbooks$institutions$current21)) %>%
  select(Name  = Institution.Name, Label = Mnemonic, Country)

locationsHistoric21 <- read.csv(here(path$AZAstudbooks$institutions$historic21)) %>%
  select(Name  = Institution.Name, Label = Mnemonic, Country) %>%
  add_row(Name = "Wild"     , Label = "VIETNAM"                     , Country = "Vietnam") %>%
  add_row(Name = "Wild"     , Label = "LAOPEOPLESDEMOCRATICREPUBLIC", Country = "Laos") %>%
  add_row(Name = "Wild"     , Label = "UNDETERMINED"                , Country = "Undetermined") %>%
  add_row(Name = "Wild"     , Label = "ASIA"                        , Country = "Undetermined") %>%
  add_row(Name = "Private Owner", Label = "GREENWICH"              , Country = "United Kingdom") %>%
  add_row(Name = "Virginia Safari Park", Label = "VASAFARI"              , Country = "United States")

locations <- bind_rows(locationsCurrent21, locationsHistoric21, locationsCurrent25) %>% 
  mutate(across(where(is.character), ~na_if(., "")),
         across(where(is.character), ~str_replace_all(., "\\n|\\t", " ")),
         across(where(is.character), ~str_trim(.))) %>%
  mutate(Label = if_else(is.na(Label), str_remove_all(Name, "(?<=.)(\\s\\w+){1,}"), Label)) %>%
  mutate(Label = str_remove_all(Label, "[^\\w+]")) %>%
  mutate(Label = str_to_upper(Label)) %>%
  distinct() %>%
  mutate(Abbrev  = as.character(str_sub(Label,  1L,  3L)),
         Abbrev2 = as.character(str_sub(Label, -2L, -1L))) %>%
  mutate(Abbrev = if_else(!is.na(lead(Abbrev)) & Abbrev == lead(Abbrev), 
                          str_replace(Abbrev, "(?<=^\\w)\\w{2}$", 
                                      Abbrev2), Abbrev), .keep = "unused") %>%
  arrange(Country, Name)


location.key <- sample(palettes_d$palettesForR$Cranes, 
                       size = length(unique(locations$Abbrev)), 
                       replace = FALSE) %>%
  as.list() %>%
  set_names(., map(as.list(unique(locations$Abbrev)), \(x) paste0(x))) %>%
  enframe(name = "Abbrev", value = "colorLoc")  %>% 
  mutate(colorLoc = as.character(colorLoc)) %>%
  right_join(locations, by = join_by(Abbrev)) %>%
  mutate(iconLoc = case_when(
    Country == "United States"             ~ "\U1F1FA\U1F1F8",
    Country == "United Kingdom"            ~ "\U1F1EC\U1F1E7",
    Country == "Vietnam"                   ~ "\U1F1FB\U1F1F3",
    Country == "Canada"                    ~ "\U1F1E8\U1F1E6",
    Country == "Denmark"                   ~ "\U1F1E9\U1F1F0",
    Country == "Germany"                   ~ "\U1F1E9\U1F1EA",
    Country == "Poland"                    ~ "\U1F1F5\U1F1F1",
    Country == "Russian Federation"        ~ "\U1F1F7\U1F1FA",
    Country == "Sweden"                    ~ "\U1F1F8\U1F1EA",
    Country == "Switzerland"               ~ "\U1F1E8\U1F1ED",
    Country == "Taiwan"                    ~ "\U1F1F9\U1F1FC",
    Country == "Thailand"                  ~ "\U1F1F9\U1F1ED",
    Country == "Laos"                      ~ "\U1F1F1\U1F1E6",
    Country == "Undetermined"              ~ "\U1F6A9",
    is.na(Country)                         ~ "\U1F6A9"
  ))

```



```{r}
living.25 <- read.csv(here(path$AZAstudbooks$living25)) %>%
  select(ID = Studbook.ID,
         Sex             = Sex.Type,
         Status          = Current.Status,
         Sire,
         Dam,
         TypeEvent       = Event.Type,
         Date,
         Location) %>%
  filter( str_detect(TypeEvent, "\\w+.+")) %>%
  mutate(Date = dmy(str_extract(Date, "\\d{1,2}/\\w{3}/\\d{2,4}")),
         across(c("Sire", "Dam"),   ~ as.character(.)),
         across(where(is.character), ~ na_if(., "")),
         across(c("Sex", "Status"), ~ str_sub(., 1L, 1L)),
         TypeEvent = fct_recode(str_to_title(TypeEvent), 
                           Capture  = "Wild Capture",
                           Birth    = "Birth/Hatch",
                           Transfer = "Transfer"  ,
                           LTF      = "Go Ltf"     ,
                           Death    = "Death" 
                           )
         ) %>%
  mutate(across(c("Sire", "Dam"),   ~ if_else(str_detect(., "^[^\\d+]"), NA, .))) %>%
  fill(ID) %>%
  group_by(ID) %>%
  fill(Sire, Dam, Sex, Status) %>%
  mutate(OrderEvent = paste0("l25_", row_number())) %>% ungroup()

alive       <- filter(living.25, Status == "A") %>% pull(ID) %>% unique()
current_pop <- pull(living.25, ID) %>% unique()

living.21 <- read.csv(here(path$AZAstudbooks$living21)) %>%
  select(ID = Studbook.ID,
         Sex             = Sex.Type,
         Sire,
         Dam,
         TypeEvent       = Event.Type,
         Date,
         Location) %>%
  filter( str_detect(TypeEvent, "\\w+.+")) %>%
  mutate(Date = dmy(str_extract(Date, "\\d{1,2}/\\w{3}/\\d{2,4}")),
         across(c("Sire", "Dam"),    ~ as.character(.)),
         across(where(is.character), ~ na_if(., "")),
         Sex = str_sub(Sex, 1L, 1L),
         TypeEvent = fct_recode(str_to_title(TypeEvent), 
                           Capture  = "Wild Capture",
                           Birth    = "Birth/Hatch",
                           Transfer = "Transfer"  ,
                           LTF      = "Go Ltf"     ,
                           Death    = "Death" 
                           )
         ) %>%
  mutate(across(c("Sire", "Dam"),   ~ if_else(str_detect(., "^[^\\d+]"), NA, .))) %>%
  fill(ID) %>%
  mutate(Status = if_else(ID %in% alive, "A", "D")) %>%
  group_by(ID) %>%
  fill(Sire, Dam, Sex) %>%
  mutate(OrderEvent = paste0("l21_", row_number())) %>% ungroup()

living <- bind_rows(living.21, living.25) %>%
  arrange(ID) %>%
  group_by(ID) %>%
  mutate(Sex = if_else(Sex == "U" & !is.na(lead(Sex)) & lead(Sex) != "U", lead(Sex), Sex))
```


```{r}
historic.21 <- read.csv(here(path$AZAstudbooks$historic21)) %>%
  select(ID              = Studbook.ID,
         Sex             = Sex.Type,
         Sire,
         Dam,
         DateBirth       = Birth.Date,
         TypeEvent       = Event.Type,
         Date,
         Location) %>%
  filter( str_detect(TypeEvent, "\\w+.+")) %>%
  mutate(across(c("Date", "DateBirth"),
                ~ dmy(str_extract(., "\\d{1,2}/\\w{3}/\\d{2,4}"))),
         across(c("Sire", "Dam"),    ~ as.character(.)),
         across(where(is.character), ~ na_if(., "")),
         Sex       = str_sub(Sex, 1L, 1L),
         TypeEvent = fct_recode(str_to_title(TypeEvent), 
                           Capture  = "Wild Capture",
                           Birth    = "Birth/Hatch",
                           Transfer = "Transfer"  ,
                           LTF      = "Go Ltf"     ,
                           Death    = "Death" 
                           )) %>%
  mutate(Location = str_to_upper(str_remove_all(Location, "[^\\w+]"))) %>%
  mutate(across(c("Sire", "Dam"),   ~ if_else(str_detect(., "^[^\\d+]"), NA, .))) %>%
  fill(ID) %>%
  mutate(Status = if_else(ID %in% alive, "A", "D")) %>%
  group_by(ID) %>%
  fill(Sire, Dam, Sex, Status, DateBirth) %>%
  mutate(Date       = if_else(is.na(Date) & !is.na(DateBirth) & TypeEvent == "Birth|Capture", DateBirth, Date),
         DateBirth  = if_else(is.na(DateBirth) & !is.na(Date) & TypeEvent == "Birth|Capture", Date, DateBirth),
         OrderEvent = paste0("h21_", row_number()))  %>%
  fill(DateBirth, .direction = "downup") %>% ungroup()
```


```{r}
studbook <- bind_rows(living, historic.21) %>% arrange(ID) %>% distinct() %>% 
  mutate(Location = na_if(Location, ""),
         Location = str_replace_all(Location, "\\n|\\t", " "),
         Location = str_trim(Location)) %>%
  mutate(Location = str_remove_all(Location, "[^\\w+]")) %>%
  mutate(Location = str_to_upper(Location))  %>%
  left_join(select(location.key, 
                   LocAbbrev = Abbrev, 
                   Label, 
                   colorLoc, 
                   NameLoc = Name, 
                   Country, 
                   iconLoc), 
            by = join_by(Location == Label))
```


```{r}
deceased <- filter(studbook, Status == "D") %>% pull(ID) %>% unique()
```


```{r}
N_records <- sum(length(deceased), length(alive))

print(N_records)
```

```{r}
births <- filter(studbook, TypeEvent == "Birth" | TypeEvent == "Capture") %>%
  select(ID, Sex, Sire, Dam, DateBirth, TypeEvent, Date, Location = LocAbbrev) %>%
  distinct() %>%
  pivot_wider(
    id_cols = c(
      "ID",
      "Sex",
      "Sire",
      "Dam",
      "DateBirth"
    ),
    names_from  = "TypeEvent",
    names_sep   = "_",
    values_from = c("Date", "Location")
  ) %>%
  mutate(
  Date = case_when(
    is.na(DateBirth) & is.na(Date_Capture) & !is.na(Date_Birth) ~ Date_Birth,
    is.na(DateBirth) & !is.na(Date_Capture) & is.na(Date_Birth) ~ Date_Capture,
    !is.na(DateBirth) ~ DateBirth
  ),
  Location = case_when(
    is.na(Location_Birth) & !is.na(Location_Capture) ~ Location_Capture,
    !is.na(Location_Birth) ~ Location_Birth
  ),
  TypeEvent = "Birth",
  .keep = "unused") %>% distinct()  %>%
  group_by(ID) %>%
  arrange(ID, desc(Sex)) %>%
  mutate(Sex = if_else(Sex == "U" & !is.na(lead(Sex)) & lead(Sex) != "U", lead(Sex), Sex)) %>%
  ungroup() %>% distinct() %>%
  left_join(select(living.25, ID, Sex_revised = Sex), by = join_by(ID)) %>%
  mutate(Sex = if_else(!is.na(Sex_revised) & Sex != Sex_revised, Sex_revised, Sex), .keep = "unused") %>% 
  distinct()

duplicates <- births %>% filter(ID == lead(ID) | ID == lag(ID))

breeding <- select(births,
                   OffspringID = ID,
                   Sire,
                   Dam,
                   Date,
                   Location) %>%
  pivot_longer(cols      = c("Sire", "Dam"),
               names_to  = "Sex",
               values_to = "ID") %>%
  mutate(Sex       = if_else(Sex == "Sire", "M", "F"),
         TypeEvent = "Breed", ID = as.integer(ID)) %>%
  filter(!is.na(ID)) %>% distinct() %>%
  group_by(ID) %>% arrange(ID, Date) %>%
  distinct() %>%
  mutate(OrderBreed = row_number())
```


```{r}
deaths <- filter(studbook, TypeEvent == "Death" | TypeEvent == "LTF") %>%
  select(ID, TypeEvent, Date, Location) %>%
  distinct() %>%
  pivot_wider(
    id_cols     = "ID",
    names_from  = "TypeEvent",
    names_sep   = "_",
    values_from = c("Date", "Location")
  ) %>%
  mutate(
  Date = case_when(
    is.na(Date_Death) & !is.na(Date_LTF) ~ Date_LTF,
    is.na(Date_LTF) & !is.na(Date_Death) ~ Date_Death
  ),
  Location = case_when(
    is.na(Location_Death) & !is.na(Location_LTF) ~ Location_LTF,
    is.na(Location_LTF) & !is.na(Location_Death) ~ Location_Death
  ),
  TypeEvent = "Death",
  .keep = "unused") %>% distinct()

duplicates <- deaths %>% filter(ID == lead(ID) | ID == lag(ID))

```

```{r}
transfers <- filter(studbook, TypeEvent == "Transfer") %>%
  select(ID, TypeEvent, Date, Location, OrderEvent) %>%
  distinct() %>%
  mutate(record     = str_sub(OrderEvent, 1L, 1L),
         OrderEvent = str_extract_all(OrderEvent, "(?<=\\w\\d{2}_)\\d+")) %>%
  group_by(ID) %>%
  arrange(ID, record, OrderEvent) %>%
  select(-c(OrderEvent, record)) %>% distinct() %>%
  mutate(OrderTrans = row_number()) %>%
  ungroup() %>%
  left_join(select(births, ID, DateBirth = Date, LocBirth = Location), by = join_by(ID)) %>%
  group_by(ID) %>%
  mutate(From      = lag(Location),
         To        = Location,
         .keep     = "unused") %>%
  mutate(From = if_else(is.na(From) & OrderTrans == 1, LocBirth, From)) %>%
  select(-LocBirth) %>%
  left_join(select(breeding, ID, DateBreed = Date, Location), by = join_by(ID, To == Location)) %>%
  left_join(select(deaths  , ID, DateDeath = Date, LocDeath = Location), by = join_by(ID)) %>%
  arrange(ID, OrderTrans, DateBreed) %>%
  group_by(ID, To) %>%
  mutate(Date = case_when(
    is.na(Date) & (OrderTrans > 1 |  max(OrderTrans) == 1)     ~ min(DateBreed) - days(2),
    is.na(Date) & OrderTrans == 1 & is.na(DateBreed)  ~ DateBirth + months(2),
    is.na(Date) & To  == LocDeath & is.na(DateBreed)  ~ DateDeath - months(2),
    is.na(Date) & To  == LocDeath & !is.na(DateBreed) ~ min(DateBreed) - days(2),
    .default = Date
  )) %>%
  ungroup() %>% group_by(ID) %>%
  mutate(Date = if_else(is.na(Date) & To  != LocDeath & is.na(DateBreed), lead(Date) - months(2), Date)) %>%
  ungroup()
```


```{r}
births.v2 <- transfers %>%
  select(ID, DateTrans = Date, OrderTrans, DateBirth) %>%
  group_by(ID) %>%
  slice_min(order_by = OrderTrans, n = 1) %>% select(-OrderTrans) %>% ungroup() %>%
  distinct() %>%
  mutate(DateBirth = if_else(is.na(DateBirth), DateTrans - months(2), DateBirth)) %>%
  select(-DateTrans) %>%
  right_join(births, by = join_by(ID)) %>%
  mutate(Date = if_else(is.na(Date), DateBirth, Date), .keep = "unused")
```

```{r}
deaths.v2 <- transfers %>%
  select(ID, DateTrans = Date, OrderTrans, DateDeath, Location = To, LocDeath, DateBreed) %>%
  filter(ID %in% deceased) %>%
  group_by(ID) %>%
  filter(OrderTrans == max(OrderTrans)) %>%
  slice_max(order_by = DateBreed, n = 1) %>%
  ungroup() %>%
  select(-OrderTrans) %>%
  distinct() %>%
  mutate(DateDeath = case_when(
    is.na(DateDeath) & !is.na(DateBreed) ~ DateBreed + months(2),
    is.na(DateDeath) & is.na(DateBreed)  ~ DateTrans + months(2),
    .default = DateDeath
      ),
    LocDeath = if_else(is.na(LocDeath), Location, LocDeath),
    .keep = "unused"
    )
```


```{r}
endRecord <- transfers %>%
  select(ID, OrderTrans, LocLast = To)  %>%
  filter(ID %in% alive) %>%
  group_by(ID) %>%
  filter(OrderTrans == max(OrderTrans)) %>% ungroup() %>%
  select(-OrderTrans) %>% distinct() %>%
  mutate(DateLast = today()) %>%
  bind_rows(select(deaths.v2, ID, DateLast = DateDeath, LocLast = LocDeath)) %>%
  arrange(ID) %>% distinct() %>%
  full_join(select(births.v2, ID, LocBirth = Location), by = join_by(ID))

duplicates <- endRecord %>% filter(ID == lead(ID) | ID == lag(ID))

```


```{r}
sires   <- select(records,
                  offspring      = ID,
                  offspringBorn  = DateBirth,
                  ID             = Sire,
                  mateID         = Dam) %>%
  inner_join(records, by = join_by(ID))

dams   <- select(records,
                  offspring      = ID,
                  offspringBorn  = DateBirth,
                  ID             = Dam,
                  mateID         = Sire) %>%
  inner_join(records, by = join_by(ID))

parents <- bind_rows(sires, dams) %>% distinct() %>%
  relocate(ID) %>%
  arrange(ID, offspringBorn) %>%
  group_by(ID) %>%
  mutate(N_Offspring = length(unique(offspring)),
         N_mates     = length(unique(mateID)),
         FirstBirth  = min(offspringBorn),
         LastBirth   = max(offspringBorn)) %>% ungroup() %>%
  select(ID,
         N_Offspring,
         N_mates    ,
         FirstBirth ,
         LastBirth  ) %>% distinct()
```

```{r}
studbook <- records %>%
  left_join(parents, by = join_by(ID)) %>%
  group_by(ID) %>%
  arrange(ID, Date) %>%
  mutate(OrderEvent = row_number()) %>%
  mutate(Date = if_else(is.na(Date) & !is.na(DateBirth) & (TypeEvent == "Wild capture" | TypeEvent == "Birth/hatch"), 
               DateBirth, Date)) %>%
  mutate(across(c("N_Offspring", "N_mates"), ~ replace_na(., 0)),
         DateBirth = case_when(
           is.na(DateBirth) & N_Offspring > 0 ~ FirstBirth - years(2), 
           is.na(DateBirth) & N_Offspring < 1 & OrderEvent == 1 ~ Date - years(1),
           !is.na(DateBirth) ~ DateBirth,
           .default = DateBirth),
         DateLast     = if_else(OrderEvent == max(OrderEvent), Date, NA),
         LocationLast = if_else(OrderEvent == max(OrderEvent), Location, NA)) %>%
  fill(DateBirth) %>%
  mutate(DateBirth = if_else(is.na(DateBirth) & is.na(Date), min(Date) - years(1), DateBirth)) %>%
  fill(DateBirth, DateLast, LocationLast, .direction = "downup") %>%
  mutate(DateLast = if_else(is.na(DateLast), Date, DateLast)) %>%
  fill(DateLast, .direction = "downup") %>%
  mutate(TypeEvent = fct(TypeEvent, levels = c(
   "Wild capture",
   "Birth/hatch",
   "Transfer"   ,
   "Go ltf"     ,
   "Death" 
  ))) %>%
  mutate(Date = case_when(
    is.na(Date) & !is.na(DateBirth) & (TypeEvent == "Wild capture" | TypeEvent == "Birth/hatch") ~ DateBirth, 
    is.na(Date) & !is.na(DateLast) & (TypeEvent == "Go ltf" | TypeEvent == "Death") ~ DateLast, 
                          .default = Date)) %>%
  ungroup() %>% arrange(ID, TypeEvent, Date)
```


```{r}
tracking <- studbook %>% 
  select(
    ID,
    Sex,
    Sire,
    Dam,
    Status,
    TypeEvent,
    Date,
    Location
    )
  
```


```{r}
CountsMonthly <- pmap(Counts, function(DateBirth, DateLast, Status)  {
    if (is.na(DateBirth)) return(NULL)
    Start <- floor_date(DateBirth, "month")
        if (Status == "Alive") {
    End <- MonthEnd
    } else if (is.na(DateLast) & Status == "Deceased") {
      return(NULL)
    } else if (!is.na(DateLast) & Status == "Deceased") {
      End <- floor_date(DateLast, "month")
    }
    return(as.list(seq(start_month, end_month, by = "months")))
}) %>%
  list_flatten() %>%
  list_c() %>%
  tibble(Date = .)  %>%
  group_by(Date) %>%
  summarize(Undetermined = n()) %>% ungroup()

```


```{r}
MonthStart <- studbook %>% slice_min(order_by = DateBirth, n = 1) %>% pull(DateBirth) %>% floor_date("month")
MonthEnd   <- floor_date(today(), "month")

```


