---
title: "Demographic Data Summaries for AZA Pygmy Loris Provisional SSP"
author: "Alicia Rich"
output:
  html_document:
    theme:
      bootswatch: litera
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: true
    code_folding: "show"
    fig_caption: true
    df_print: paged
params:
  sampleset: "loris"
  dataset: "culi"
                     
---

```{r global, message = FALSE}
global             <- config::get(config = "default")

here::i_am("DemographicsLorises.Rmd")
source(here::here(global$setup))

source(here(path$AZAstudbooks$functions))
source(here(path$AZAstudbooks$add))
```

```{r, warning = FALSE}
alive <- read.csv(here(path$AZAstudbooks$living25)) %>% 
  filter(Current.Status == "Alive") %>% 
  pull(Studbook.ID) %>% c(2638)

locations <- bind_rows(read.csv(here(path$AZAstudbooks$institutions$current25)), 
                       read.csv(here(path$AZAstudbooks$institutions$current21)), 
                       read.csv(here(path$AZAstudbooks$institutions$historic21)),
                       loc.extra) %>% clean.locations() %>% enhance.locations()

living.25   <- read.csv(here(path$AZAstudbooks$living25))   %>% 
  clean_studbook(., alive, locations)

living.21   <- read.csv(here(path$AZAstudbooks$living21))   %>% 
  clean_studbook(., alive, locations) %>%
  filter(!(ID %in% pull(living.25, ID)))

historic.21 <- read.csv(here(path$AZAstudbooks$historic21)) %>% 
  clean_studbook(., alive, locations) %>%
  filter(!(ID %in% pull(living.25, ID))) %>%
  filter(!(ID %in% pull(living.21, ID)))

```

```{r}
studbook <- bind_rows(living.25, 
                      living.21, 
                      historic.21, 
                      missing) %>%
  mutate(TypeEvent = fct(TypeEvent, 
                         levels = c("Birth", "Transfer", "End")),
         across(c(Sire, Dam), ~ na_if(., 0))) %>%
  arrange(ID, OrderLoc, TypeEvent) %>%
  distinct() %>%
  group_by(ID) %>%
  mutate(StartLoc = if_else(TypeEvent != "End", Date, lag(Date)),
         EndLoc   = if_else(TypeEvent == "End", Date, lead(Date))) %>%
  select(
    ID,
    Status,
    OrderLoc,
    Location,
    TypeEvent,
    StartLoc,
    Date,
    EndLoc,
    NameLoc,
    Country,
    Sex,
    Sire,
    Dam
  ) %>% ungroup()


end.records <- studbook %>%
  select(ID,
         Status,
         OrderLoc,
         Location,
         TypeEvent,
         StartLoc,
         Date,
         EndLoc
  ) %>%
  slice_tail(n = 1, by = ID) %>%
  filter(TypeEvent != "End") %>%
  mutate(Date = if_else(Status == "A", today(), NA),
         TypeEvent = "End") %>% 
  mutate(EndLoc = Date) %>%
  select(-Status) %>% distinct()
```


```{r, warning = FALSE}
timeline <- studbook %>%
  filter(TypeEvent == "Birth" & !is.na(Sire)) %>%
  select(ID      = Sire,
         OffspID = ID,
         Location,
         Date) %>%
  bind_rows(select(filter(studbook, TypeEvent == "Birth" & !is.na(Dam)),
                   ID      = Dam,
                   OffspID = ID,
                   Location,
                   Date)) %>%
  left_join(select(studbook,
                   ID,
                   OrderLoc,
                   Location,
                   StartLoc,
                   EndLoc
                   ), by = join_by(ID, Location)) %>%
  mutate(check = if_else(
    between(Date, StartLoc, EndLoc) | 
      is.na(StartLoc) & Date < EndLoc | 
      is.na(EndLoc) & Date > StartLoc | 
      (is.na(StartLoc) & is.na(EndLoc)) | is.na(Date),
    "keep",
    "discard"
  )) %>% filter(check == "keep") %>%
  mutate(TypeEvent = "Breed") %>%
  select(-c(check, OffspID)) %>% 
  bind_rows(end.records) %>%
  distinct() %>% 
  arrange(ID, 
          OrderLoc,
          Date) %>%
  bind_rows(select(studbook,
                   ID,
                   OrderLoc,
                   Location,
                   TypeEvent,
                   StartLoc,
                   Date,
                   EndLoc)) %>% 
  distinct() %>% 
  mutate(TypeEvent = fct(TypeEvent, levels = c(
    "Birth",
    "Transfer",
    "Breed",
    "End"
  ))) %>%
  arrange(ID, 
          OrderLoc,
          TypeEvent,
          Date) %>%
  select(ID,
         OrderLoc,
         Location,
         StartLoc,
         TypeEvent,
         Date,
         EndLoc) %>%
  group_by(ID) %>%
  mutate(Date = case_when(
    is.na(Date) & TypeEvent != "End"  & TypeEvent != "Breed" ~ StartLoc,
    is.na(Date) & TypeEvent == "End"  ~ EndLoc,
    is.na(Date) & TypeEvent == "Birth" ~ lead(Date) - years(1),
    is.na(Date) & TypeEvent == "Transfer" & lead(TypeEvent) != "End" ~
      lag(Date) + days(floor(as.numeric(as.period((interval(lag(Date), lead(Date))), unit = "days"), "days")/2)),
    .default = Date
  )) %>%
  mutate(Date = if_else(
    is.na(Date) & TypeEvent == "Transfer" & lead(TypeEvent) != "End",
    lag(Date) + days(floor(as.numeric(as.period((interval(lag(Date), lead(Date))), unit = "days"), "days")/2)),
    Date
  )) %>%
  mutate(Date = if_else(
    is.na(Date) & lag(TypeEvent) == "Birth" & is.na(lag(Date)),
    lead(Date) - years(1), Date
  )) %>%
  mutate(Date = case_when(
    is.na(Date) & TypeEvent == "Birth" ~ lead(Date) - years(1),
    is.na(Date) & TypeEvent == "End" & !(ID %in% alive) ~ lag(Date) + years(1),
    .default = Date)) %>%
  mutate(
    StartLoc = case_when(
      TypeEvent == "Breed" ~ lag(StartLoc),
      TypeEvent != "End" & TypeEvent != "Breed" ~ Date,
      TypeEvent == "End" & lag(TypeEvent) != "Breed" ~ lag(Date),
      .default = StartLoc
      ),
    EndLoc = case_when(
      TypeEvent == "Breed" & Location == lead(Location) ~ lead(EndLoc),
      lead(TypeEvent) == "Transfer" | lead(TypeEvent) == "End" ~ lead(Date),
      TypeEvent == "End" ~ Date,
      .default = EndLoc
      )
    ) %>% group_by(ID, Location) %>%
  fill(StartLoc, EndLoc, .direction = "updown") %>%
  ungroup()
```

```{r, warning = FALSE}
studbook.revised <- timeline %>%
  filter(TypeEvent != "Breed") %>%
  left_join(select(
    studbook,
    ID,
    Status,
    OrderLoc,
    Location,
    NameLoc,
    Country,
    Sex,
    Sire,
    Dam
  ), by = join_by(ID, OrderLoc, Location)) %>% distinct() %>%
  mutate(DateBirth = if_else(TypeEvent == "Birth", Date, NA)) %>%
  group_by(ID) %>% fill(DateBirth) %>% ungroup()

```


```{r, warning = FALSE}
location.dates <- studbook.revised %>%
  select(
    ID,
    Sex,
    Location,
    DateBirth,
    StartLoc,
    EndLoc
  ) %>% distinct()

monthly.census <- pmap(
  list(
    pull(location.dates, StartLoc),
    pull(location.dates, EndLoc),
    pull(location.dates, DateBirth),
    pull(location.dates, Location),
    pull(location.dates, Sex),
    pull(location.dates, ID)
  ), census_by_month) %>%
  bind_rows() %>%
  group_by(Date, Location) %>%
  summarise(Individuals = list(
    tibble(ID, Sex, Age)), 
    .groups = "drop") %>%
  group_by(Date) %>%
  summarise(Locations = split(Individuals, 
                              Location), 
            .groups = "drop") %>%
  split(.$Date) %>%
  map(~ .x$Locations)
```


```{r, warning = FALSE}
find.sires <- whoisthedaddy(studbook.revised, monthly.census)
find.dams  <- whoisthemommy(studbook.revised, monthly.census)
```

```{r}
final.studbook <- studbook.revised %>%
  mutate(Sire = case_match(ID, 
                           1047 ~ 1012, 
                           2645 ~ 1131, .default = Sire)) %>%
  add.hypotheticals(c(1045, 1046), "Sire") %>%
  add.hypotheticals(c(2423, 2424), "Sire") %>%
  add.hypotheticals(c(2108), "Sire") %>%
  add.hypotheticals(c(2717), "Dam") %>%
  add.hypotheticals(c(2717), "Sire")

write.table(final.studbook, here(path$AZAstudbooks$working), sep = "\t", row.names = F)
```

```{r}
visual.studbook <- final.studbook %>%
  group_by(ID) %>%
  mutate(Age  = calculate_age(DateBirth, Date),
         Year = year(Date)) %>%
  left_join(select(locations, -Label), by = join_by(
    Location == LocAbbrev,
    Country,
    NameLoc
  )) %>%
  mutate(color = case_match(Sex, 
                            "F" ~ colors$f, 
                            "M" ~ colors$m, 
                            "U" ~ colors$u))
```

```{css, echo = FALSE}

.flag {
  height: 1.3rem;
  border: 1px solid #f0f0f0;
}

.LocAbbrev {
  font-family: "Bungee Inline", sans-serif;
  font-size: 1.25rem;
}

.Names {
  font-family: "News Cycle", sans-serif;
  font-size: 0.75rem;
  font-weight: 300;
  display: flex;
  flex-wrap: wrap;
}

.cell-text {
  display: flex;
  flex-direction: column;
  justify-content: space-evenly;
}

.location-cell {
  display: flex;
  flex-direction: row;
  justify-content: flex-start;
}

```

```{r}

```



