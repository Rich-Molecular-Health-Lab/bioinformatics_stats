---
title: "Demographic Data Summaries for AZA Pygmy Loris Provisional SSP"
author: "Alicia Rich"
output:
  html_document:
    theme:
      bootswatch: litera
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: true
    code_folding: "show"
    fig_caption: true
    df_print: paged
params:
  sampleset: "loris"
  dataset: "culi"
                     
---

```{r global, message = FALSE}
global             <- config::get(config = "default")

here::i_am("DemographicsLorises.Rmd")
source(here::here(global$setup))
```

```{r}
comments <- list(
  "ANALYTICAL DATA FOR TRUE INDIVIDUALS" = list(
    "2108" = list(
    "Field"   = "Sire",
    "TRUE"    = "UNK",
    "Overlay" = "HYP1",
    "Note"    = 
    "No individuals in the SB are recorded as having been at institution at which 2108 was born (IRCHEL) other than SB#s 2108 and 2097. Therefore, created and assigned a wild-origin hypothetical sire, which seems reasonable given the birth date of SB# 2108 and the origins of the recorded mother."),
  "2717" = list(
    "Field"   = c("Sire", "Dam"),
    "TRUE"    = "UNK",
    "Overlay" = c("HYP2", "HYP3"),
    "Note"    = 
    "This individual is possibly from the pet trade. No other animals from GREENWICH or VA SAFARI have previously entered the studbook, so the animal is unlikely to be related to any individuals currently in the population. Assumed to have wild (unrelated) origins.")
  ),
  "HYPOTHETICAL INDIVIDUALS" = list(
    "HYP1" = list(
      "Sire" = "WILD",
      "Dam"  = "WILD",
      "Note" = "To represent likely wild caught sire of SB# 2108, which was born at IRCHEL in Switzerland on 4/10/1989."
    ),
    "HYP2" = list(
      "Sire" = "WILD",
      "Dam"  = "WILD",
      "Note" = "Created to represent parents of 2717, which is likely unrelated to the rest of the population due to origin."),
    "HYP3" = list(
      "Sire" = "WILD",
      "Dam"  = "WILD",
      "Note" = "Created to represent parents of 2717, which is likely unrelated to the rest of the population due to origin.")
  )
)
```

```{r}
locationsCurrent25 <- read.csv(here(path$AZAstudbooks$institutions$current25)) %>%
  select(Name    = Institution.Name, Label   = Mnemonic) %>%
  mutate(Country = "United States")

locationsCurrent21 <- read.csv(here(path$AZAstudbooks$institutions$current21)) %>%
  select(Name  = Institution.Name, Label = Mnemonic, Country)

locationsHistoric21 <- read.csv(here(path$AZAstudbooks$institutions$historic21)) %>%
  select(Name  = Institution.Name, Label = Mnemonic, Country)

locations <- bind_rows(locationsCurrent21, locationsHistoric21, locationsCurrent25) %>% 
  mutate(across(where(is.character), ~na_if(., "")),
         across(where(is.character), ~str_replace_all(., "\\n|\\t", " ")),
         across(where(is.character), ~str_trim(.))) %>%
  mutate(Label = if_else(is.na(Label), str_remove_all(Name, "(?<=.)(\\s\\w+){1,}"), Label)) %>%
  mutate(Label = str_remove_all(Label, "[^\\w+]")) %>%
  mutate(Label = str_to_upper(Label)) %>%
  distinct() %>%
  mutate(Abbrev  = as.character(str_sub(Label,  1L,  3L)),
         Abbrev2 = as.character(str_sub(Label, -2L, -1L))) %>%
  mutate(Abbrev = if_else(!is.na(lead(Abbrev)) & Abbrev == lead(Abbrev), 
                          str_replace(Abbrev, "(?<=^\\w)\\w{2}$", 
                                      Abbrev2), Abbrev), .keep = "unused") %>%
  arrange(Country, Name)


location.key <- sample(palettes_d$palettesForR$Cranes, 
                       size = length(unique(locations$Abbrev)), 
                       replace = FALSE) %>%
  as.list() %>%
  set_names(., map(as.list(unique(locations$Abbrev)), \(x) paste0(x))) %>%
  enframe(name = "Abbrev", value = "colorLoc") %>%
  right_join(locations, by = join_by(Abbrev)) %>%
  mutate(iconLoc = case_when(
    Country == "United States"             ~ "\U1F1FA\U1F1F8",
    Country == "United Kingdom"            ~ "\U1F1EC\U1F1E7",
    Country == "Vietnam"                   ~ "\U1F1FB\U1F1F3",
    Country == "Canada"                    ~ "\U1F1E8\U1F1E6",
    Country == "Denmark"                   ~ "\U1F1E9\U1F1F0",
    Country == "Germany"                   ~ "\U1F1E9\U1F1EA",
    Country == "Poland"                    ~ "\U1F1F5\U1F1F1",
    Country == "Russian Federation"        ~ "\U1F1F7\U1F1FA",
    Country == "Sweden"                    ~ "\U1F1F8\U1F1EA",
    Country == "Switzerland"               ~ "\U1F1E8\U1F1ED",
    Country == "Taiwan"                    ~ "\U1F1F9\U1F1FC",
    Country == "Thailand"                  ~ "\U1F1F9\U1F1ED",
    Country == "Undetermined"              ~ "\U1F6A9",
    is.na(Country)                         ~ "\U1F6A9"
  ))

```



```{r}
living.25 <- read.csv(here(path$AZAstudbooks$living25)) %>%
  select(ID = Studbook.ID,
         LocationCurrent = Current.Location,
         Sex             = Sex.Type,
         Status          = Current.Status,
         Sire,
         Dam,
         TypeBirth       = Birth.Type,
         TypeEvent       = Event.Type,
         Date,
         Location) %>%
  filter( str_detect(TypeEvent, "\\w+.+")) %>%
  mutate(Date = dmy(str_extract(Date, "\\d{1,2}/\\w{3}/\\d{2,4}")),
         across(c("Sire", "Dam"), ~ as.character(.))) %>%
  fill(ID) %>%
  mutate(record = "living25") %>%
  group_by(ID) %>%
  mutate(OrderEvent = row_number()) %>% ungroup()

living.21 <- read.csv(here(path$AZAstudbooks$living21)) %>%
  select(ID = Studbook.ID,
         LocationCurrent = Current.Location,
         Sex             = Sex.Type,
         Status          = Current.Status,
         Sire,
         Dam,
         TypeBirth       = Birth.Type,
         TypeEvent       = Event.Type,
         Date,
         Location) %>%
  filter( str_detect(TypeEvent, "\\w+.+")) %>%
  mutate(Date = dmy(str_extract(Date, "\\d{1,2}/\\w{3}/\\d{2,4}")),
         across(c("Sire", "Dam"), ~ as.character(.))) %>%
  fill(ID) %>%
  mutate(record = "living21") %>%
  group_by(ID) %>%
  mutate(OrderEvent = row_number()) %>% ungroup()

historic.21 <- read.csv(here(path$AZAstudbooks$historic21)) %>%
  select(ID = Studbook.ID,
         LocationCurrent = Current.Location,
         Sex             = Sex.Type,
         Sire,
         Dam,
         TypeBirth       = Birth.Type,
         DateBirth       = Birth.Date,
         TypeEvent       = Event.Type,
         Date,
         Location) %>%
  filter( str_detect(TypeEvent, "\\w+.+")) %>%
  mutate(across(c("Date", "DateBirth"),
                ~ dmy(str_extract(., "\\d{1,2}/\\w{3}/\\d{2,4}"))),
         across(c("Sire", "Dam"), ~ as.character(.)),
         Status = "Deceased") %>%
  fill(ID) %>%
  mutate(record = "historic21") %>%
  group_by(ID) %>%
  mutate(OrderEvent = row_number()) %>% ungroup()
```


```{r}
records <- bind_rows(living.25, living.21, historic.21) %>%
  mutate(record = fct(record, levels = c("living25", "living21", "historic21"))) %>%
  arrange(desc(ID), record, OrderEvent) %>%
  mutate(across(c("Location", "LocationCurrent"), 
                ~ str_to_upper(str_remove_all(., "[^\\w+]"))),
         Sex = str_remove_all(Sex, "[^\\w+]")) %>%
  mutate(across(c("Sire", "Dam"), ~ case_when(
           str_detect(., "WILD") ~ "0",
           str_detect(., "\\d+") ~ .,
           .default = NA))) %>%
  mutate(across(where(is.character), ~ na_if(., ""))) %>%
  group_by(ID) %>%
  fill(LocationCurrent, Sex, Sire, Dam, TypeBirth, DateBirth) %>%
  mutate(Date = if_else(is.na(Date) & !is.na(DateBirth) & str_detect(TypeEvent, "Birth"),
                        DateBirth, Date),
         DateBirth = if_else(is.na(DateBirth) & !is.na(Date) & str_detect(TypeEvent, "Birth"),
                        Date, DateBirth),
         Status = case_when(
           !is.na(Status)                                      ~ Status,
           OrderEvent = max(OrderEvent) & TypeEvent != "Death" ~ "Alive",
           TypeEvent == "Death"                                ~ "Deceased"
         )) %>%
  fill(Status, DateBirth, .direction = "downup") %>%
  mutate(Date = if_else(is.na(Date) & str_detect(TypeEvent, "Capture"), DateBirth, Date)) %>%
  select(-c(record, OrderEvent)) %>% arrange(desc(ID), Date) %>% distinct() %>%
  mutate(LocationBorn = if_else(str_detect(TypeEvent, "Birth"), Location, NA)) %>%
  fill(LocationBorn, .direction = "downup") %>%
  mutate(ID = as.character(ID),
         TypeEvent = str_to_sentence(TypeEvent)) %>% arrange(ID) %>%
  ungroup()
```

```{r}
sires   <- select(records,
                  offspring      = ID,
                  offspringBorn  = DateBirth,
                  ID             = Sire,
                  mateID         = Dam) %>%
  inner_join(records, by = join_by(ID))

dams   <- select(records,
                  offspring      = ID,
                  offspringBorn  = DateBirth,
                  ID             = Dam,
                  mateID         = Sire) %>%
  inner_join(records, by = join_by(ID))

parents <- bind_rows(sires, dams) %>% distinct() %>%
  relocate(ID) %>%
  arrange(ID, offspringBorn) %>%
  group_by(ID) %>%
  mutate(N_Offspring = length(unique(offspring)),
         N_mates     = length(unique(mateID)),
         FirstBirth  = min(offspringBorn),
         LastBirth   = max(offspringBorn)) %>% ungroup() %>%
  select(ID,
         N_Offspring,
         N_mates    ,
         FirstBirth ,
         LastBirth  ) %>% distinct()
```

```{r}
studbook <- records %>%
  left_join(parents, by = join_by(ID)) %>%
  group_by(ID) %>%
  arrange(ID, Date) %>%
  mutate(OrderEvent = row_number()) %>%
  mutate(Date = if_else(is.na(Date) & !is.na(DateBirth) & (TypeEvent == "Wild capture" | TypeEvent == "Birth/hatch"), 
               DateBirth, Date)) %>%
  mutate(across(c("N_Offspring", "N_mates"), ~ replace_na(., 0)),
         DateBirth = case_when(
           is.na(DateBirth) & N_Offspring > 0 ~ FirstBirth - years(2), 
           is.na(DateBirth) & N_Offspring < 1 & OrderEvent == 1 ~ Date - years(1),
           !is.na(DateBirth) ~ DateBirth,
           .default = DateBirth),
         DateLast     = if_else(OrderEvent == max(OrderEvent), Date, NA),
         LocationLast = if_else(OrderEvent == max(OrderEvent), Location, NA)) %>%
  fill(DateBirth) %>%
  mutate(DateBirth = if_else(is.na(DateBirth) & is.na(Date), min(Date) - years(1), DateBirth)) %>%
  fill(DateBirth, DateLast, LocationLast, .direction = "downup") %>%
  mutate(DateLast = if_else(is.na(DateLast), Date, DateLast)) %>%
  fill(DateLast, .direction = "downup") %>%
  mutate(TypeEvent = fct(TypeEvent, levels = c(
   "Wild capture",
   "Birth/hatch",
   "Transfer"   ,
   "Go ltf"     ,
   "Death" 
  ))) %>%
  mutate(Date = case_when(
    is.na(Date) & !is.na(DateBirth) & (TypeEvent == "Wild capture" | TypeEvent == "Birth/hatch") ~ DateBirth, 
    is.na(Date) & !is.na(DateLast) & (TypeEvent == "Go ltf" | TypeEvent == "Death") ~ DateLast, 
                          .default = Date)) %>%
  ungroup() %>% arrange(ID, TypeEvent, Date)
```


```{r}
tracking <- studbook %>% 
  select(
    ID,
    Sex,
    Sire,
    Dam,
    Status,
    TypeEvent,
    Date,
    Location
    )
  
```


```{r}
CountsMonthly <- pmap(Counts, function(DateBirth, DateLast, Status)  {
    if (is.na(DateBirth)) return(NULL)
    Start <- floor_date(DateBirth, "month")
        if (Status == "Alive") {
    End <- MonthEnd
    } else if (is.na(DateLast) & Status == "Deceased") {
      return(NULL)
    } else if (!is.na(DateLast) & Status == "Deceased") {
      End <- floor_date(DateLast, "month")
    }
    return(as.list(seq(start_month, end_month, by = "months")))
}) %>%
  list_flatten() %>%
  list_c() %>%
  tibble(Date = .)  %>%
  group_by(Date) %>%
  summarize(Undetermined = n()) %>% ungroup()

```


```{r}
MonthStart <- studbook %>% slice_min(order_by = DateBirth, n = 1) %>% pull(DateBirth) %>% floor_date("month")
MonthEnd   <- floor_date(today(), "month")

```


