---
title: "spare"
output: html_document
---

## Verify Tree

```{r}
refs_aligned <- treeio::read.fasta("microeco/loris/refs_aligned_mafft.fasta")
```

```{r}
phylo_tree <- read.tree("microeco/loris/refs_tree.treefile")
```


## Collapse to Genus Level

### Join Taxonomic Data to Tree

```{r}
load("microeco/loris/tax_table.RData")

tax_table <- tax.table %>%
  rownames_to_column("label") %>%
  mutate(label_genus = case_when(
    Genus == "g__" & Family == "f__" & Order == "o__" & Class == "c__" & Phylum == "p__" ~as.character(str_glue("{Genus}{Family}{Order}{Class}{Phylum}{Kingdom}")),
    Genus == "g__" & Family == "f__" & Order == "o__" & Class == "c__" & Phylum != "p__" ~as.character(str_glue("{Genus}{Family}{Order}{Class}{Phylum}")),
    Genus == "g__" & Family == "f__" & Order == "o__" & Class != "c__" ~as.character(str_glue("{Genus}{Family}{Order}{Class}")),
    Genus == "g__" & Family == "f__" & Order != "o__" ~as.character(str_glue("{Genus}{Family}{Order}")),
    Genus == "g__" & Family != "f__" ~as.character(str_glue("{Genus}{Family}")),
    Genus != "g__" ~ Genus,
    .default = Genus
  ))  %>%
  mutate(label_family = case_when(
    Family == "f__" & Order == "o__" & Class == "c__" & Phylum == "p__" ~as.character(str_glue("{Family}{Order}{Class}{Phylum}{Kingdom}")),
    Family == "f__" & Order == "o__" & Class == "c__" & Phylum != "p__" ~as.character(str_glue("{Family}{Order}{Class}{Phylum}")),
    Family == "f__" & Order == "o__" & Class != "c__" ~as.character(str_glue("{Family}{Order}{Class}")),
    Family == "f__" & Order != "o__"                  ~as.character(str_glue("{Family}{Order}")),
    Family != "f__" ~ Family,
    .default = Family
  ))  %>%
  mutate(label_order = case_when(
    Order == "o__" & Class == "c__" & Phylum == "p__" ~as.character(str_glue("{Order}{Class}{Phylum}{Kingdom}")),
    Order == "o__" & Class == "c__" & Phylum != "p__" ~as.character(str_glue("{Order}{Class}{Phylum}")),
    Order == "o__" & Class != "c__"                   ~as.character(str_glue("{Order}{Class}")),
    Order != "o__" ~ Order,
    .default = Order
  ))  %>%
  mutate(label_class = case_when(
    Class == "c__" & Phylum == "p__" ~as.character(str_glue("{Class}{Phylum}{Kingdom}")),
    Class == "c__" & Phylum != "p__" ~as.character(str_glue("{Class}{Phylum}")),
    Class != "c__" ~ Class,
    .default = Class
  ))  %>%
  mutate(label_phylum = case_when(
    Phylum == "p__" ~as.character(str_glue("{Phylum}{Kingdom}")),
    Phylum != "p__" ~ Phylum,
    .default = Phylum
  ))
```

```{r}
tree_tbl <- as_tibble(phylo_tree) %>%
  full_join(tax_table, by = "label")
```

```{r}
tree_grouped <- as_tibble(phylo_tree) %>%
  groupOTU(split(tree_tbl$label, tree_tbl$label_phylum ),"phylum", overlap = "overwrite") %>%
  groupOTU(split(tree_tbl$label, tree_tbl$label_class ), "class" , overlap = "overwrite") %>%
  groupOTU(split(tree_tbl$label, tree_tbl$label_order ), "order" , overlap = "overwrite") %>%
  groupOTU(split(tree_tbl$label, tree_tbl$label_family), "family", overlap = "overwrite") %>%
  groupOTU(split(tree_tbl$label, tree_tbl$label_genus ), "genus" , overlap = "overwrite") %>%
  as.treedata()
```



```{r}
view_tree <- ggtree(tree_grouped, branch.length = "none") +
  aes(color = phylum) +
  theme(legend.position="none")
view_tree
```


```{r}
phylo_genus <- phyloseq(
  otu_table(otu.table, taxa_are_rows = TRUE),
  phy_tree(phylo_tree),
  tax_table(as.matrix(tax.table)),
  sample_data(sample.table)
  ) %>%
  tax_glom("Genus")
```

```{r}
ggtree(phylo_genus)
```



```{r}
gen_singles <- tree_tbl %>%
  filter(genus_count == 1) %>%
  select(clade = label_genus, node)

gen_nodes <- split(tree_tbl$node, tree_tbl$label_genus) %>%
  keep(\(x) length(x) > 1)

getCladeNode <- function(tree, nodesvec, gname) {
  nodenum <- getMRCA(tree, tip = nodesvec)
  tibble(clade = gname, node = nodenum)
}

genNodes <- imap(gen_nodes, \(x, idx) getCladeNode(phylo_tree, x, idx)) %>%
  list_rbind() %>%
  bind_rows(gen_singles) %>%
  arrange(node)

```


```{r}
collapsed_tree <- reduce(
  genNodes$node, 
  \(x, y) collapse(x, y, mode = "max", fill = "transparent"), 
  .init = view_tree
  ) %<+% genNodes

collapsed_tree +
  geom_label(aes(label = clade))
```

```{r}
genus_data <- as.treedata(collapsed_tree) %>%
  as_tibble() %>%
  left_join(tax_table, by = "label") %>%
  relocate(label_genus, .after = clade) %>%
  arrange(label_genus, node)
```


```{r}
genus_tree <- collapsed_tree

genus_tree$data <- genus_tree$data %>%
  mutate(
    isTip = if_else(is.na(clade), FALSE, TRUE),
    label = if_else(!is.na(clade), clade, NA)
    )
```

```{r}
genus_tree
```



```{r}
orders <- split(tree_tbl$node, tree_tbl$label_order) %>%
  keep(\(x) length(x) > 1) 
```

```{r}
collapse_orders <- function(tree, group) {
  tree %>%
  CollapseEdge(group)
}

order_tree <- reduce(orders, collapse_orders, .init = phylo_tree)
```


```{r}
for (i in seq_along(orders)) {
  order  <- names(orders)[[i]]
  otu    <- orders[[i]]
}
```


```{r}
for (order in orders) {
  order_tree <- groupOTU(as_tibble(phylo_tree), order, overlap = "origin")
}

```



```{r}
plot(order_tree)
```


```{r}
nodes_phylum <- split(tree@data$node, tree@data$label_phylum) %>%
  map(\(x) as.integer(x))

collapse_phylum <- map(nodes_phylum, \(x) getMRCA(phylo_tree, x)) %>%
  keep(\(x) length(x) > 0)

for (mrca in collapse_phylum) {
  tree_phylum <- TreeTools::CollapseNode(phylo_tree, node = mrca)
}

plot(tree_phylum)
```


```{r}
genus_tbl <- tree_tbl %>%
  mutate(label = label_genus)

tree_genus <- as.treedata(genus_tbl)

view_genus_tree <- ggtree(tree_genus, branch.length='none')
view_genus_tree
```


```{r}
class_tbl <- tree_tbl %>%
  mutate(label = label_class)

tree_class <- as.treedata(class_tbl)

view_class_tree <- ggtree(tree_class, branch.length='none')
view_class_tree
```


```{r}
tree <- as.treedata(tree_tbl)
```


```{r}
plot(tree@phylo)
```

```{r}
nodes_genus <- split(tree@data$node, tree@data$label_genus) %>%
  map(\(x) as.integer(x))

collapse_genus <- map(nodes_genus, \(x) getMRCA(tree@phylo, x)) %>%
  keep(\(x) length(x) > 0)

for (mrca in collapse_genus) {
  tree_genus <- TreeTools::CollapseNode(tree@phylo, node = mrca)
}

plot(tree_genus)
```


```{r}
plot(phylo_tree)

nodes_phylum <- split(tree@data$node, tree@data$label_phylum) %>%
  map(\(x) as.integer(x))

collapse_phylum <- map(nodes_phylum, \(x) getMRCA(phylo_tree, x)) %>%
  keep(\(x) length(x) > 0)

for (mrca in collapse_phylum) {
  tree_phylum <- TreeTools::CollapseNode(phylo_tree, node = mrca)
}

plot(tree_phylum)
```




```{r}
nodes_genus <- split(tree@data$node, tree@data$label_genus) %>%
  map(\(x) as.integer(x))

collapse_genus <- map(nodes_genus, \(x) getMRCA(tree@phylo, x)) %>%
  keep(\(x) length(x) > 0)
```


```{r}
for (mrca in collapse_genus) {
  tree_genus <- TreeTools::CollapseNode(tree@phylo, node = mrca)
}
```



```{r}
tree <- as.treedata(tree_tbl)
tree_view <- ggtree(tree, branch.length='none')

nodes_genus <- split(tree@data$node, tree@data$label_genus) %>%
  map(\(x) as.integer(x))

collapse_genus <- map(nodes_genus, \(x) getMRCA(phylo_tree, x)) %>%
  keep(\(x) length(x) > 0)

tree_genus <- tree_view

for (mrca in collapse_genus) {
  tree_genus <- ggtree::collapse(tree_genus, node = mrca)
}
```

```{r}
tree_view
tree_genus
```

```{r}
genus_phylo <- as
```



```{r}
nodes_phylum <- split(tree@data$node, tree@data$label_phylum) %>%
  map(\(x) as.integer(x))

collapse_phylum <- map(nodes_phylum, \(x) getMRCA(phylo_tree, x)) %>%
  keep(\(x) length(x) > 0)

tree_phylum <- tree_view

for (mrca in collapse_phylum) {
ggtree::collapse(tree_phylum, node = mrca)
}
```



```{r}
for (g in unique(tax$Genus)) {
  tips <- tax$organism[tax$Genus == g]
  # skip monospecific genera
  if (length(tips) < 2) next
  mrca <- getMRCA(phy, tips)
  # collapse that node (turns the clade into a single multifurcation)
  phy <- collapse(phy, node = mrca)
}

# 4) write out, if you like
write.tree(phy, "microeco/loris/tree.genus_collapsed.nwk")

# 5) visualise
p <- ggtree(phy, branch.length = "none") +
     geom_tiplab()

```



```{r}
tree_phylum <- imap(nodes_phylum, \(x, idx) groupClade(as_tibble(tree), .node = x, group_name = idx))
```


```{r}
for (clade in nodes_phylum) {
tidytree::groupClade(as_tibble(tree_phylum), .node = clade)
}
```

```{r}
tree_phylum
tree_view
```



```{r}
ancestors_genus <- map(nodes_genus, \(x) getMRCA(phylo_tree, x)) %>%
  modify2(., nodes_genus, \(x, y) if (is.null(x)) y else x)
```



