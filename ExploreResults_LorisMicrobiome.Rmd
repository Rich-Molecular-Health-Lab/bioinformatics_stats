---
title: "Loris Microbiome Project Results Overview - IN PROGRESS"
author: "Alicia Rich"
output:
  html_document:
    theme:
      bootswatch: litera
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: true
    code_folding: "show"
    fig_caption: true
    df_print: paged
params:
  sampleset: "loris"
                     
---

```{r, include = F}
global             <- config::get(config = "default")

here::i_am("ExploreResults_LorisMicrobiome.Rmd")
source(here::here(global$setup))
source(here::here(swan$functions))


for (file in swan$swan_scripts) {
  source(here(file))
}


source(here(path$metadata$key))
source(here(path$metadata$factors))
```


```{r, include = F}
dataset_dir <- path$microeco$dataset

theme_set(theme_classic())
thematic_rmd()
thematic_on(accent = "#8785B2FF", fg = "black")
```

# Read in Data

I have written several custom functions to expedite some of the functions that I reuse multiple times for data sets across different sample and taxon subsets. The loop below will use one of those functions to read the microeco datasets that I built using the [MicroEcoDataPrep](MicroEcoDataPrep.html) script.  
  
This code makes use of the dataset paths referenced in my config.yaml file. To see the full path (relative to the repository base directory), refer to the relative syntax in this script and the config file below.  

```{r, echo = FALSE}
page_fluid(
    accordion(
      open = FALSE,
      accordion_panel(
        "Show/Hide Config File (config.yml)",
        tagList(tags$pre(includeText("config.yml")))
    )
  )
)
```



```{r}
# Define dataset categories
dataset_types <- c("tax", "function")
tax_levels    <- c("species", "genus", "family", "order", "class", "phylum")
func_levels   <- c("kegg", "fpt", "njc")
datasets      <- c("main", "culi", "warb")

# Create an empty list to store all datasets
microtable_datasets <- list()

# Helper function to safely read files
safe_read <- function(file, ...) {
  if (file.exists(file)) {
    return(read.table(file, ...))
  } else {
    warning(paste("File missing:", file))
    return(NULL)
  }
}

# Loop through dataset types (taxonomic and functional)
for (data_type in dataset_types) {
  levels <- if (data_type == "tax") tax_levels else func_levels
  
  for (level in levels) {
    for (dataset in datasets) {
      # Extract dataset path from config
      if (!is.null(dataset_dir[[dataset]][[level]])) {
        directory <- dataset_dir[[dataset]][[level]]
      } else {
        warning(paste("Path not found in config for:", dataset, level))
        next  # Skip this iteration if the path is missing
      }
      
      # Generate dataset name
      prefix       <- substr(level, 1, 3)  # Extract first 3 letters
      dataset_name <- paste0(prefix, ".dataset.", dataset)

      # Read required files
      sample_tab  <- safe_read(file.path(directory, "sample_table.tsv") , sep = "\t", header = TRUE, row.names = 1)
      tax_table   <- safe_read(file.path(directory, "tax_table.tsv")    , sep = "\t", header = TRUE, row.names = 1)
      otu_table   <- safe_read(file.path(directory, "feature_table.tsv"), sep = "\t", header = TRUE, row.names = 1)

      # Create dataset object
      if (data_type == "tax") {
        phylo_tree <- if (file.exists(file.path(directory, 
                                                "phylo_tree.tre"))) read.tree(file.path(directory, 
                                                                                        "phylo_tree.tre")) else NULL
        rep_fasta  <- if (file.exists(file.path(directory, 
                                                "rep_fasta.fasta"))) read.fasta(file.path(directory, 
                                                                                          "rep_fasta.fasta")) else NULL

        microtable_datasets[[dataset_name]] <- microtable$new(
          sample_table = sample_tab,
          otu_table    = otu_table,
          tax_table    = tax_table,
          phylo_tree   = phylo_tree,
          rep_fasta    = rep_fasta,
          auto_tidy    = TRUE
        )
      } else {
        microtable_datasets[[dataset_name]] <- microtable$new(
          sample_table = sample_tab,
          otu_table    = otu_table,
          tax_table    = tax_table,
          auto_tidy    = TRUE
        )
      }
    }
  }
}

# Convert list to global environment variables if needed
list2env(microtable_datasets, envir = .GlobalEnv)
```

```{r}

```


