---
title: "Population Data Management Lab"
author: "Alicia Rich"
output:
  html_document:
    theme:
      bootswatch: litera
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: true
    code_folding: "hide"
    fig_caption: true
    df_print: paged
params:
  course: "zoobio"
  semester: "spring25"
  group: "MakeupVersion"
  
---


```{r, include = FALSE}
library(knitr)
library(conflicted)
library(downloadthis)
library(fontawesome)
library(glue)
library(ggplot2)
library(ggtext)
library(heatmaply)
library(here)
library(htmltools)
library(htmlwidgets)
library(kableExtra)
library(kinship2)
library(paletteer)
library(pedtools)
library(pedsuite)
library(plotly)
library(reactable)
library(reactablefmtr)
library(rmarkdown)
library(scales)
library(shiny)
library(showtext)
library(thematic)
library(tidyverse)
library(tippy)
library(usethis)
library(visNetwork)


conflicts_prefer(here::here)
conflicts_prefer(dplyr::filter)
conflicts_prefer(dplyr::select)
conflicts_prefer(dplyr::left_join)
conflicts_prefer(dplyr::inner_join)
conflicts_prefer(dplyr::full_join)
conflicts_prefer(dplyr::semi_join)
conflicts_prefer(dplyr::rename)
conflicts_prefer(ggplot2::margin)
conflicts_prefer(ggplot2::theme_classic)
conflicts_prefer(ggplot2::ggplot)
conflicts_prefer(ggplot2::theme_minimal)
conflicts_prefer(ggplot2::aes)
conflicts_prefer(dplyr::lag)
conflicts_prefer(purrr::set_names)
conflicts_prefer(purrr::flatten)
conflicts_prefer(purrr::discard_at)
conflicts_prefer(base::which.max)
conflicts_prefer(lubridate::month)
conflicts_prefer(lubridate::year)
conflicts_prefer(lubridate::day)
conflicts_prefer(base::as.data.frame)
conflicts_prefer(htmltools::p)
conflicts_prefer(purrr::discard)
conflicts_prefer(ribd::kinship)
conflicts_prefer(plotly::layout)

here::i_am("PopDataMakeupVersion.Rmd")

source("reactables_PopDataMakeup.R")

theme_set(theme_classic())
thematic_rmd()
thematic_on(accent = "#8785B2FF", fg = "black")

opts_chunk$set(message = FALSE,
               warning = FALSE,
               echo    = TRUE,
               include = TRUE,
               eval    = TRUE,
               comment = "")

palette <- c("#D53288FF", "#DC8045FF", "#21B14BFF", "#008AC2FF", "#3F459BFF")

colors <- list(
  f = "#D53288FF",
  m = "#3F459BFF",
  u = "#21B14BFF",
  sire = "#3F459B33",
  dam  = "#D5328833",
  emph = "#DC8045FF",
  seq  = "rcartocolor::Sunset",
  div  = "rcartocolor::Temps",
  rand = "khroma::stratigraphy"
)

col.pal <- keep_at(colors, c("f", "m", "u")) %>% unlist()
col.pal <- setNames(col.pal, c("F", "M", "U"))
fills   <- gsub("FF", "33", col.pal)


deceased.col <- function(color) {
  gsub("FF", "33", color)
}

font_add_google("Noto Sans Symbols", family = "NotoSym")
showtext_auto()

```


# Format Studbook Data

Run the code below to automatically import and format studbook data for the Pygmy Slow Loris.

```{r}
source(here(path$AZAstudbooks$functions))
source(here("metadata/loris/reactables_PopDataMakeup.R"))
```


```{r}
studbook        <- read.table(here("metadata/loris/Studbook/studbook_loris_reactableReady.tsv"), sep = "\t", header = TRUE) %>%
  mutate(DateBirth = ymd(DateBirth))
timeline        <- read.table(here("metadata/loris/Studbook/working_timeline_loris25.tsv"), sep = "\t", header = TRUE) %>%
  mutate(across(c(StartLoc, Date, EndLoc), ~ ymd(.)))
```

```{r}
source(here("metadata/loris/reactables_PopDataMakeup.R"))
```


## View Formatted File

Let's take a glimpse of our formatted studbook now.

```{r, out.width="100%"}
studbook.tbl <- studbook %>%
  studbook.react(., studbook.cols(.), groupBy = "Status")

studbook.tbl
```

# Population Viability Analysis

## Demographic Trends

Let's look at the basic population size over time to begin quantifying growth rate and assessing overall population viability.

```{r}
raw.counts <- timeline %>%
    filter(TypeEvent %in% c("Birth", "End")) %>%
    distinct(ID, Date, TypeEvent) %>%
    pivot_wider(id_cols     = "ID",
                names_from  = "TypeEvent",
                values_from = "Date") %>%
    distinct() %>%
    mutate(Birth = floor_date(Birth, "years"),
           End   = ceiling_date(End, "years")) %>%
    mutate(Years = pmap(list(Birth, End), \(x, y) seq(x, y, by = "year"))) %>%
  unnest(Years) %>%
  select(ID, Year = Years) %>%
  mutate(Age = row_number() - 1, .by = ID) %>%
  left_join(select(studbook,
                   ID,
                   Sex), by = join_by(ID)) %>%
  summarize(N = n(), .by = c(Sex, Year)) %>%
  distinct() %>%
  arrange(Year)
```

```{r}
population.plot <- plot_ly(
    data        = raw.counts,
    type        = "scatter",
    x           = ~Year,
    y           = ~N,
    color       = ~Sex,
    colors      = col.pal,
    mode        = "lines+markers",
    connectgaps = TRUE,
    line        = list(
      shape     = "spline",
      color     = ~Sex,
      colors    = col.pal,
      width     = 1.5
      ),
    marker      = list(
      fill      = ~Sex,
      colors    = fills,
      size      = 6,
      opacity   = 0.7,
      line      = list(
      color     = ~Sex,
      colors    = col.pal,
      width     = 1.0
        )
   )) %>%
  layout(title        = "Pygmy Loris Population Trends 1966-2025",
         plot_bgcolor = "#ffffff", 
         yaxis = list(title         = "Individuals Alive",
                      showline      = T,
                      zerolinewidth = 2,
                      zerolinecolor = "black",
                      showgrid      = F),
         xaxis = list(title         = "Date",
                      showline      = T,
                      zerolinewidth = 2,
                      zerolinecolor = "black",
                      showgrid      = T,
                      rangeslider   = list(visible = T)))

saveWidget(population.plot, paste0("PopulationTrends_", params$group, ".html"))

population.plot
```





## Life Table Calculations

Now we will use annual birth counts to follow the standard method for computing a normalized rate of growth over the past 5 years compared to all years.

```{r}
life.table.sexes <- count_births(timeline, studbook) %>%
      summarize(Births = sum(Births),
                Nx     = n(), 
                .by    = c(BirthYear, Sex, Age)
                ) %>%
      ungroup() %>%
  make_cohorts(., 1985, 2024, 5, 22, TRUE) %>%
  summarize(Births = sum(Births),
           Nx      = sum(Nx), 
           .by     = c(CohortLabel, BirthCohort, Sex, Cohort, Age)) %>%
  arrange(BirthCohort, Sex, Age) %>%
  lifeTab()

lifeTab.5yrs <- count_births(timeline, studbook) %>%
      summarize(Births = sum(Births),
                Nx     = n(), 
                .by    = c(BirthYear, Age)
                ) %>%
      ungroup() %>%
  make_cohorts(., 1985, 2024, 5, 22, FALSE) %>%
  summarize(Births = sum(Births),
           Nx      = sum(Nx), 
           .by     = c(CohortLabel, BirthCohort, Cohort, Sex, Age)) %>%
  arrange(BirthCohort, Age) %>%
  lifeTab() %>%
  bind_rows(life.table.sexes) %>%
  arrange(BirthCohort, Age, Sex)

lifeTab.static <- lifeTab_static(lifeTab.5yrs) %>%
  annotate_lambda()
```

```{r}
lambda.plot <- plot_ly(
    data        = filter(lifeTab.static, Sex != "Total"),
    type        = "scatter",
    x           = ~CohortLabel,
    y           = ~lambda,
    color       = ~Sex,
    colors      = col.pal,
    text        = ~hover_lambda,
    mode        = "lines+markers",
    connectgaps = TRUE,
    line        = list(
      shape     = "spline",
      color     = ~Sex,
      colors    = col.pal,
      width     = 1.5
      ),
    marker      = list(
      fill      = ~Sex,
      colors    = fills,
      size      = 6,
      opacity   = 0.7,
      line      = list(
      color     = ~Sex,
      colors    = col.pal,
      width     = 1.0
        )
   )) %>%
  layout(title        = "Pygmy Loris Population Growth 1985-2024",
         plot_bgcolor = "#ffffff", 
         barmode      = "grouped",
         shapes       = list(hline(1.0)),
         annotations  = lambda.annotation,
         yaxis = list(title         = "Lambda (\u03BB)",
                      showline      = T,
                      zerolinewidth = 2,
                      zerolinecolor = "black",
                      showgrid      = F),
         xaxis = list(title         = "Birth Cohort",
                      showline      = T,
                      zerolinewidth = 2,
                      zerolinecolor = "black",
                      showgrid      = T))

saveWidget(lambda.plot, paste0("PopulationGrowth_", params$group, ".html"))
lambda.plot
```


