```{r}
timeline.revised <- assemble_timeline(final.studbook) %>%
  mutate(TypeEvent = if_else(TypeEvent == "End" & ID %in% deceased, "Death", TypeEvent)) %>%
  filter(TypeEvent != "End") %>%
  select(ID, Location, TypeEvent, Date) %>%
  distinct()
```

```{r}
births <- timeline.revised %>%
  filter(TypeEvent == "Birth") %>%
  as_tsibble(key = Date, index = ID, regular = FALSE)
```

```{r}
biographic <- final.studbook %>%
  group_by(ID) %>%
  mutate(DateLast = max(Date),
         LocBirth = if_else(TypeEvent == "Birth"     , Location, NA),
         LocLast  = if_else(OrderLoc == max(OrderLoc), Location, NA)) %>%
  mutate(AgeLast = calculate_age(DateBirth, DateLast)) %>%
  fill(LocBirth) %>%
  fill(LocLast, .direction = "up") %>%
  select(
    ID,
    Status,
    AgeLast,
    Sex,
    Sire,
    Dam,
    DateBirth,
    LocBirth,
    DateLast,
    LocLast
  ) %>% distinct() %>%
  left_join(select(btp25), by = join_by())
```

```{r}
tally_events <- function(df, interval) {
  if (interval == "month") {
    records <- df %>%
      mutate(Date = floor_date(Date, "month"))
    seqby <- paste0("months")
  } else if (interval == "year") {
    records <- df %>%
      mutate(Date = floor_date(Date, "year"))
    seqby <- paste0("years")
  }
  
  list <-  list(pull(records, ID),
                pull(records, Sex), 
                pull(records, Date))
  pmap(list, \(x, y, z) tibble(
    Date = seq(y, by = seqby),
    ID   = x,
    Sex  = z
  )) %>%
    map_depth(., 1, \(x) distinct(x)) %>%
    map_depth(., 1, \(x) arrange(x, Sex, ID)) %>% 
    bind_rows() %>% group_by(Date) %>%
    summarise(Individuals = list(tibble(ID, Sex)), .groups = "drop") %>%
    split(.$Date)
  
}

```

